<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0d1117">
<title>Asistencia · Antología Box23</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">

<style>
/* ── Variables ─────────────────────────────────────────── */
:root {
    --teal:    #27F9D4;
    --pink:    #FF729F;
    --yellow:  #F0F66E;
    --bg:      #0d1117;
    --surface: #161b22;
    --card:    #1c2333;
    --border:  rgba(255,255,255,.08);
    --text:    #e6edf3;
    --muted:   #8b949e;
    --success: #3fb950;
    --danger:  #f85149;
    --warning: #d29922;
    --radius:  12px;
}

/* ── Reset & base ───────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; background: var(--bg); color: var(--text);
    font-family: 'Barlow', sans-serif; overflow-x: hidden; }

/* ── Header ─────────────────────────────────────────────── */
.app-header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: .75rem 1.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .75rem;
    position: sticky;
    top: 0;
    z-index: 100;
}
.brand {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 1.35rem;
    letter-spacing: .04em;
    text-transform: uppercase;
    color: var(--teal);
    white-space: nowrap;
}
.brand span { color: var(--text); font-weight: 400; }

.header-date {
    font-size: .8rem;
    color: var(--muted);
    text-align: right;
    line-height: 1.3;
}
.header-date strong { color: var(--text); font-size: .95rem; display: block; }

/* ── Counter bar ─────────────────────────────────────────── */
.counter-bar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: .5rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    font-size: .82rem;
}
.counter-item { display: flex; align-items: center; gap: .4rem; }
.counter-item .num {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 1.4rem;
    font-weight: 800;
    line-height: 1;
}
.counter-item .lbl { color: var(--muted); font-size: .75rem; line-height: 1.2; }
.counter-item.c-present .num { color: var(--success); }
.counter-item.c-absent  .num { color: var(--danger); }
.counter-item.c-total   .num { color: var(--teal); }
.divider-v { width: 1px; height: 2rem; background: var(--border); }

/* ── Search bar ──────────────────────────────────────────── */
.search-wrap {
    padding: .75rem 1rem;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: .5rem;
    align-items: center;
}
.search-wrap input {
    flex: 1;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    padding: .55rem .9rem;
    font-size: .9rem;
    font-family: 'Barlow', sans-serif;
    outline: none;
    transition: border-color .15s;
}
.search-wrap input::placeholder { color: var(--muted); }
.search-wrap input:focus { border-color: var(--teal); }
.btn-mark-all {
    background: rgba(39,249,212,.12);
    border: 1px solid var(--teal);
    color: var(--teal);
    border-radius: 8px;
    padding: .5rem .75rem;
    font-size: .78rem;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .05em;
    cursor: pointer;
    white-space: nowrap;
    transition: background .15s;
}
.btn-mark-all:hover { background: rgba(39,249,212,.22); }

/* ── User list ───────────────────────────────────────────── */
.user-list {
    padding: .5rem .75rem 5rem;
    display: flex;
    flex-direction: column;
    gap: .4rem;
}

.user-row {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    padding: .6rem .9rem;
    gap: .5rem;
    transition: border-color .15s, transform .1s;
    animation: slideIn .2s ease both;
}
.user-row:active { transform: scale(.99); }
.user-row.is-present { border-color: rgba(63,185,80,.35); background: rgba(63,185,80,.06); }
.user-row.is-absent  { border-color: rgba(248,81,73,.25); background: rgba(248,81,73,.04); }

@keyframes slideIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
}

.user-info { min-width: 0; }
.user-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 1.05rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    letter-spacing: .02em;
}
.user-meta {
    font-size: .73rem;
    color: var(--muted);
    margin-top: .1rem;
    display: flex;
    gap: .5rem;
    flex-wrap: wrap;
    align-items: center;
}
.meta-tag {
    background: rgba(255,255,255,.06);
    border-radius: 4px;
    padding: .1rem .35rem;
    font-size: .68rem;
}

/* Vigencia badge en la fila */
.vigencia-inline {
    font-size: .7rem;
    padding: .1rem .4rem;
    border-radius: 4px;
    white-space: nowrap;
}
.vig-ok      { background: rgba(63,185,80,.18);  color: #3fb950; }
.vig-warn    { background: rgba(210,153,34,.18);  color: #d29922; }
.vig-expired { background: rgba(248,81,73,.18);   color: #f85149; }
.vig-none    { background: rgba(139,148,158,.12); color: #8b949e; }

/* ── Action buttons ──────────────────────────────────────── */
.btn-group-attend {
    display: flex;
    gap: .35rem;
    flex-shrink: 0;
}
.btn-attend {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all .15s;
    background: rgba(255,255,255,.05);
    color: var(--muted);
}
.btn-attend:hover  { transform: scale(1.08); }
.btn-attend:active { transform: scale(.94); }

.btn-attend.present        { background: rgba(63,185,80,.15); border-color: rgba(63,185,80,.4); color: var(--success); }
.btn-attend.present.active { background: var(--success); border-color: var(--success); color: #0d1117; }
.btn-attend.absent         { background: rgba(248,81,73,.12); border-color: rgba(248,81,73,.3); color: var(--danger); }
.btn-attend.absent.active  { background: var(--danger);  border-color: var(--danger);  color: #fff; }

/* ── Toast ───────────────────────────────────────────────── */
.toast-box {
    position: fixed;
    bottom: 1.25rem;
    left: 50%;
    transform: translateX(-50%) translateY(6px);
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: .65rem 1.2rem;
    font-size: .85rem;
    box-shadow: 0 8px 32px rgba(0,0,0,.5);
    z-index: 999;
    opacity: 0;
    transition: opacity .2s, transform .2s;
    white-space: nowrap;
    pointer-events: none;
}
.toast-box.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast-box.success { border-color: rgba(63,185,80,.5); color: var(--success); }
.toast-box.info    { border-color: rgba(39,249,212,.4); color: var(--teal); }

/* ── Loading ─────────────────────────────────────────────── */
#loadingState {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 3rem 1rem;
    color: var(--muted);
}
.spinner {
    width: 40px; height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--teal);
    border-radius: 50%;
    animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ── Error banner ─────────────────────────────────────────── */
.error-banner {
    background: rgba(248,81,73,.1);
    border: 1px solid rgba(248,81,73,.3);
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
    margin: 1rem;
    color: var(--danger);
    font-size: .85rem;
    display: none;
}

/* ── Empty state ─────────────────────────────────────────── */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--muted);
}
.empty-state i { font-size: 2.5rem; margin-bottom: .75rem; opacity: .3; display: block; }

/* ── Confirm modal overlay ────────────────────────────────── */
.confirm-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,.7);
    z-index: 500;
    align-items: flex-end;
    justify-content: center;
}
.confirm-overlay.open { display: flex; }
.confirm-sheet {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius) var(--radius) 0 0;
    padding: 1.5rem 1.25rem;
    width: 100%;
    max-width: 480px;
    animation: slideUp .2s ease;
}
@keyframes slideUp { from { transform: translateY(60px); opacity:0; } to { transform: translateY(0); opacity:1; } }
.confirm-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 800; font-size: 1.2rem; margin-bottom: .4rem; }
.confirm-text  { font-size: .85rem; color: var(--muted); margin-bottom: 1.25rem; }
.confirm-btns  { display: flex; gap: .5rem; }
.confirm-btns button {
    flex: 1; padding: .75rem; border-radius: 8px; font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700; font-size: 1rem; letter-spacing: .05em; text-transform: uppercase; cursor: pointer; border: none;
}
.btn-confirm-yes { background: var(--success); color: #0d1117; }
.btn-confirm-no  { background: var(--border); color: var(--text); }

/* ── Scrollbar ────────────────────────────────────────────── */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
</style>
</head>
<body>

<!-- Header -->
<header class="app-header">
    <div class="brand">Box23 <span>/ Asistencia</span></div>
    <div class="header-date">
        <strong id="headerDay">—</strong>
        <span id="headerDate">cargando...</span>
    </div>
</header>

<!-- Counter bar -->
<div class="counter-bar">
    <div class="counter-item c-present">
        <span class="num" id="cntPresent">0</span>
        <span class="lbl">Presentes</span>
    </div>
    <div class="divider-v"></div>
    <div class="counter-item c-absent">
        <span class="num" id="cntAbsent">0</span>
        <span class="lbl">Ausentes</span>
    </div>
    <div class="divider-v"></div>
    <div class="counter-item c-total">
        <span class="num" id="cntTotal">0</span>
        <span class="lbl">Total</span>
    </div>
</div>

<!-- Search + mark all -->
<div class="search-wrap">
    <input type="text" id="searchInput" placeholder="&#xf002;  Buscar usuario..." autocomplete="off" autocorrect="off">
    <button class="btn-mark-all" id="btnMarkAll">
        <i class="fas fa-check-double"></i> Todos presentes
    </button>
</div>

<!-- Error banner -->
<div class="error-banner" id="errorBanner"></div>

<!-- User list -->
<div class="user-list" id="userList">
    <div id="loadingState">
        <div class="spinner"></div>
        <span>Cargando usuarios...</span>
    </div>
</div>

<!-- Toast -->
<div class="toast-box" id="toast"></div>

<!-- Confirm sheet -->
<div class="confirm-overlay" id="confirmOverlay">
    <div class="confirm-sheet">
        <div class="confirm-title" id="confirmTitle">¿Confirmar?</div>
        <div class="confirm-text"  id="confirmText"></div>
        <div class="confirm-btns">
            <button class="btn-confirm-no"  id="confirmNo">Cancelar</button>
            <button class="btn-confirm-yes" id="confirmYes">Confirmar</button>
        </div>
    </div>
</div>

<!-- ── Scripts compartidos con la app principal ────────────── -->
<script src="js/utils.js"></script>
<script src="js/storage.js"></script>

<script>
/* ═══════════════════════════════════════════════════════════
   Página de Asistencia — standalone
   Usa Storage y Utils del proyecto principal.
   No depende de Bootstrap JS, ui.js, ni ningún otro módulo.
   ═══════════════════════════════════════════════════════════ */

const today = Utils.getCurrentDate();
let attendanceCache = [];   // registros de asistencia del día
let usersCache      = [];   // usuarios activos sin entrenadores
let searchTerm      = '';

/* ── Cabecera de fecha ────────────────────────────────────── */
(function setHeaderDate() {
    const [y, m, d] = today.split('-').map(Number);
    const date = new Date(y, m - 1, d);
    const days = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
    document.getElementById('headerDay').textContent  = days[date.getDay()];
    document.getElementById('headerDate').textContent =
        date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
})();

/* ── Toast ────────────────────────────────────────────────── */
let toastTimer;
function showToast(msg, type = 'success') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className   = 'toast-box show ' + type;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 2200);
}

/* ── Confirm sheet ────────────────────────────────────────── */
function showConfirm(title, text) {
    return new Promise(resolve => {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmText').textContent  = text;
        document.getElementById('confirmOverlay').classList.add('open');
        const yes = document.getElementById('confirmYes');
        const no  = document.getElementById('confirmNo');
        const close = (val) => {
            document.getElementById('confirmOverlay').classList.remove('open');
            yes.removeEventListener('click', onYes);
            no.removeEventListener('click',  onNo);
            resolve(val);
        };
        const onYes = () => close(true);
        const onNo  = () => close(false);
        yes.addEventListener('click', onYes);
        no.addEventListener('click',  onNo);
    });
}

/* ── Vigencia helpers ─────────────────────────────────────── */
function getVigenciaInfo(userId) {
    const payments = Storage.getIncome()
        .filter(p => p.userId === userId && p.startDate && p.endDate)
        .sort((a, b) => (b.startDate || '').localeCompare(a.startDate || ''));
    if (!payments.length) return null;
    return payments[0];
}

function vigenciaTag(userId) {
    const pay = getVigenciaInfo(userId);
    if (!pay) return '<span class="vigencia-inline vig-none">Sin pago</span>';
    const end    = Utils.normalizeDate(pay.endDate);
    const diff   = Math.floor((new Date(today + 'T00:00:00') - new Date(end + 'T00:00:00')) / 86400000);
    if (diff < 0)  return `<span class="vigencia-inline vig-ok">Vigente · ${Utils.formatDate(end)}</span>`;
    if (diff === 0) return `<span class="vigencia-inline vig-warn">Vence hoy</span>`;
    return `<span class="vigencia-inline vig-expired">Vencida · ${diff}d</span>`;
}

/* ── Contadores ───────────────────────────────────────────── */
function updateCounters() {
    const ids      = usersCache.map(u => u.id);
    const records  = attendanceCache.filter(a => ids.includes(a.userId));
    const present  = records.filter(a => a.status === 'presente').length;
    const absent   = records.filter(a => a.status === 'ausente').length;
    document.getElementById('cntPresent').textContent = present;
    document.getElementById('cntAbsent').textContent  = absent;
    document.getElementById('cntTotal').textContent   = usersCache.length;
}

/* ── Render lista ─────────────────────────────────────────── */
function renderList() {
    const list = document.getElementById('userList');
    const term = searchTerm.toLowerCase();

    const filtered = term
        ? usersCache.filter(u => u.name.toLowerCase().includes(term))
        : usersCache;

    if (filtered.length === 0) {
        list.innerHTML = `<div class="empty-state">
            <i class="fas fa-user-slash"></i>
            ${term ? 'Sin resultados para "' + Utils.escapeHtml(term) + '"' : 'No hay usuarios activos'}
        </div>`;
        return;
    }

    list.innerHTML = filtered.map((u, idx) => {
        const rec    = attendanceCache.find(a => a.userId === u.id);
        const status = rec?.status || null;
        const rowCls = status === 'presente' ? 'is-present' : status === 'ausente' ? 'is-absent' : '';
        const timeStr = rec?.time ? `<span class="meta-tag"><i class="fas fa-clock" style="font-size:.6rem"></i> ${rec.time}</span>` : '';

        return `<div class="user-row ${rowCls}" id="row-${u.id}" style="animation-delay:${idx * 0.025}s">
            <div class="user-info">
                <div class="user-name">${Utils.escapeHtml(u.name)}</div>
                <div class="user-meta">
                    ${u.classTime ? `<span class="meta-tag"><i class="fas fa-clock" style="font-size:.6rem"></i> ${u.classTime}</span>` : ''}
                    ${vigenciaTag(u.id)}
                    ${timeStr}
                </div>
            </div>
            <div class="btn-group-attend">
                <button class="btn-attend present ${status === 'presente' ? 'active' : ''}"
                        onclick="markUser('${u.id}', 'presente')" title="Presente">
                    <i class="fas fa-check"></i>
                </button>
                <button class="btn-attend absent ${status === 'ausente' ? 'active' : ''}"
                        onclick="markUser('${u.id}', 'ausente')" title="Ausente">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>`;
    }).join('');

    updateCounters();
}

/* ── Marcar asistencia ────────────────────────────────────── */
async function markUser(userId, status) {
    const existing = attendanceCache.find(a => a.userId === userId);
    const time     = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

    // Actualizar cache local inmediatamente (UX responsivo)
    if (existing) {
        existing.status = status;
        existing.time   = time;
    } else {
        attendanceCache.push({ id: 'tmp-' + Date.now(), userId, date: today, status, time });
    }
    renderList();

    // Persistir en Sheets
    try {
        if (existing && !existing.id.startsWith('tmp-')) {
            await Storage.updateAttendance(existing.id, { status, time });
        } else {
            const saved = await Storage.addAttendance({ userId, date: today, status, time });
            // Actualizar el id temporal con el real
            const idx = attendanceCache.findIndex(a => a.userId === userId);
            if (idx !== -1 && saved) attendanceCache[idx] = { ...attendanceCache[idx], id: saved.id || attendanceCache[idx].id };
        }
        const label = status === 'presente' ? '✓ Presente' : '✗ Ausente';
        const user  = usersCache.find(u => u.id === userId);
        showToast(`${user?.name?.split(' ')[0] || ''} — ${label}`, status === 'presente' ? 'success' : 'info');
    } catch (err) {
        showToast('Error al guardar. Verifica conexión.', 'info');
    }
}

/* ── Marcar todos presentes ───────────────────────────────── */
document.getElementById('btnMarkAll').addEventListener('click', async () => {
    const ok = await showConfirm(
        'Marcar todos presentes',
        '¿Marcar a todos los usuarios activos como presentes ahora?'
    );
    if (!ok) return;

    const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    for (const u of usersCache) {
        const existing = attendanceCache.find(a => a.userId === u.id);
        if (existing) { existing.status = 'presente'; existing.time = time; }
        else attendanceCache.push({ id: 'tmp-' + u.id, userId: u.id, date: today, status: 'presente', time });
    }
    renderList();
    showToast(`${usersCache.length} usuarios marcados como presentes`, 'success');

    // Persistir en segundo plano
    for (const u of usersCache) {
        const existing = Storage.getAttendanceByDate(today).find(a => a.userId === u.id);
        try {
            if (existing) await Storage.updateAttendance(existing.id, { status: 'presente', time });
            else          await Storage.addAttendance({ userId: u.id, date: today, status: 'presente', time });
        } catch (_) { /* continuar */ }
    }
});

/* ── Búsqueda ────────────────────────────────────────────── */
document.getElementById('searchInput').addEventListener('input', (e) => {
    searchTerm = e.target.value;
    renderList();
});

/* ── Inicialización ──────────────────────────────────────── */
async function init() {
    const list = document.getElementById('userList');
    try {
        await Storage.initialize();

        usersCache      = Storage.getUsers()
            .filter(u => u.status === 'active' && u.affiliationType !== 'Entrenador(a)');
        attendanceCache = Storage.getAttendanceByDate(today);

        if (usersCache.length === 0) {
            list.innerHTML = `<div class="empty-state">
                <i class="fas fa-users"></i>
                No hay usuarios activos registrados
            </div>`;
            return;
        }
        renderList();
    } catch (err) {
        list.innerHTML = '';
        const banner = document.getElementById('errorBanner');
        banner.style.display = 'block';
        banner.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>
            Error al cargar datos: ${err.message}.<br>
            <small>Verifica la conexión con Google Sheets o que SCRIPT_URL esté configurado en storage.js</small>`;
    }
}

init();
</script>
</body>
</html>
