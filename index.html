<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Configuración para GitHub Pages -->
    <!--/* <base href="/antologia-box23/"> */-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antología Box23 - Sistema de Gestión</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #27F9D4;
            --color-secondary: #FF729F;
            --color-background: #273043;
            --color-dark: #1a2332;
            --color-light: #f8f9fa;
            --color-table-header: #424b5f;
            --color-table-hover: #324466;
            --color-table: #3a4357;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar-brand {
            color: var(--color-primary) !important;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .navbar-brand img {
            height: 50px;
            margin-right: 10px;
        }

        .card {
            background-color: var(--color-dark);
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            color: var(--color-light);
        }

        .card-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: var(--color-dark);
            border-bottom: none;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }

        .nav-tabs {
            border-bottom: 2px solid var(--color-primary);
        }

        .nav-tabs .nav-link {
            color: var(--color-light);
            border: none;
            padding: 12px 20px;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: var(--color-dark);
            border: none;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
        }

        .table {
            color: var(--color-light) !important;
            border-collapse: separate;
            border-spacing: 0;
            background-color: var(--color-table) !important;
        }

        .table th {
            background-color: var(--color-table-header);
            color: var(--color-primary) !important;
            border-color: rgba(255, 255, 255, 0.1);
            padding: 12px 15px;
            position: sticky;
            top: 0;
        }

        .table td {
            border-color: rgba(255, 255, 255, 0.1);
            color: var(--color-light) !important;
            padding: 10px 15px;
            vertical-align: middle;
            background-color: var(--color-table) !important;
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.05) !important;
        }

        .table-hover tbody tr:hover {
            background-color: var(--color-table-hover) !important;
        }

        .form-control,
        .form-select {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--color-light);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.25rem rgba(39, 249, 212, 0.25);
            color: var(--color-light);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-dark);
            font-weight: bold;
        }

        .btn-primary:hover {
            background-color: #1de5c0;
            border-color: #1de5c0;
            color: var(--color-dark);
        }

        .btn-success {
            background-color: var(--color-secondary);
            border-color: var(--color-secondary);
            color: white;
        }

        .btn-success:hover {
            background-color: #ff5a8f;
            border-color: #ff5a8f;
            color: white;
        }

        .btn-info {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-dark);
        }

        .summary-card {
            border-left: 4px solid var(--color-primary);
            color: var(--color-light);
        }

        .summary-card .card-title {
            color: var(--color-primary);
        }

        .summary-card .card-text {
            color: var(--color-light);
        }

        #exportBtn {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            border: none;
            color: var(--color-dark);
            font-weight: bold;
        }

        .class-time {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--color-light);
        }

        .class-time h6 {
            color: var(--color-primary);
        }

        .attendance-badge {
            font-size: 0.85em;
            padding: 5px 8px;
        }

        .package-warning {
            background-color: rgba(255, 114, 159, 0.2);
            border-left: 4px solid var(--color-secondary);
            color: var(--color-light);
        }

        .membership-warning {
            background-color: rgba(255, 193, 7, 0.2);
            border-left: 4px solid #ffc107;
            color: var(--color-light);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .import-export-card {
            border: 2px dashed var(--color-primary);
            color: var(--color-light);
        }

        .whatsapp-modal .message-preview {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #25D366;
            color: var(--color-light);
        }

        .autorestore-section {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: var(--color-light);
        }

        .fix-highlight {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--color-primary);
            color: var(--color-light);
        }

        .tab-content {
            min-height: 500px;
        }

        .modal-content {
            background-color: var(--color-dark);
            color: var(--color-light);
        }

        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--color-dark);
        }

        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-label {
            color: var(--color-primary);
        }

        .text-muted {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        .alert-warning {
            background-color: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
            color: var(--color-light);
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%2327F9D4' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        }

        .form-select option {
            background-color: var(--color-dark);
            color: var(--color-light);
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .logo-placeholder {
            width: 200px;
            height: 100px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-dark);
            font-weight: bold;
            font-size: 24px;
            margin: 0 auto;
        }

        .date-range {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .table-container {
            background-color: var(--color-dark);
            padding: 15px;
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
        }

        .report-summary {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .total-row {
            font-weight: bold;
            background-color: rgba(39, 249, 212, 0.2) !important;
        }

        .whatsapp-survey {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .backup-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
            background-color: var(--color-secondary);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .table thead th {
            border-bottom: 2px solid var(--color-primary);
        }

        .badge {
            font-weight: 500;
        }

        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .google-form-link {
            color: var(--color-primary);
            text-decoration: none;
            border-bottom: 1px dashed var(--color-primary);
        }

        .google-form-link:hover {
            color: #1de5c0;
            text-decoration: none;
            border-bottom: 1px solid #1de5c0;
        }

        .validation-error {
            border: 1px solid #ff5a8f !important;
            box-shadow: 0 0 0 0.25rem rgba(255, 90, 143, 0.25) !important;
        }

        .user-status-badge {
            font-size: 0.75em;
            padding: 3px 6px;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .emergency-info {
            background-color: rgba(255, 114, 159, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 4px solid var(--color-secondary);
        }

        .phone-validation-error {
            color: #ff5a8f;
            font-size: 0.875em;
            margin-top: 0.25rem;
            display: none;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Estilos para la nueva sección de asistencias mejorada */
        .attendance-user-list {
            background-color: var(--color-dark);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .attendance-user-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--color-light) !important;
        }

        .attendance-user-item:last-child {
            border-bottom: none;
        }

        .attendance-user-info {
            flex: 1;
        }

        .attendance-user-name {
            font-weight: 500;
            color: var(--color-light) !important;
            margin-bottom: 5px;
        }

        .attendance-user-details {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7) !important;
        }

        .attendance-check-container {
            margin-right: 15px;
        }

        .attendance-actions {
            display: flex;
            gap: 10px;
        }

        /* Asegurar que todo el texto en la sección de asistencia sea blanco */
        #attendance * {
            color: var(--color-light) !important;
        }

        .attendance-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .attendance-stat-item {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .attendance-stat-icon {
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .attendance-stat-content h5 {
            margin: 0;
            font-size: 1.2rem;
        }

        .attendance-stat-content p {
            margin: 0;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .attendance-filters {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .attendance-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        /* Estilos para el modal de importación */
        .import-summary {
            max-height: 300px;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }

        .import-summary-item {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .import-summary-item:last-child {
            border-bottom: none;
        }

        .import-success {
            color: var(--color-primary);
        }

        .import-warning {
            color: #ffc107;
        }

        .import-error {
            color: #ff5a8f;
        }

        /* Estilos para el modal de cumpleaños */
        .birthday-badge {
            background: linear-gradient(135deg, #FF729F, #FFB347);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .birthday-item:last-child {
            border-bottom: none;
        }

        .birthday-user-info {
            flex: 1;
        }

        .birthday-user-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .birthday-user-details {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .birthday-date {
            font-weight: bold;
            color: var(--color-primary);
        }

        .birthday-actions {
            display: flex;
            gap: 10px;
        }

        /* Estilos para las alertas de inasistencias */
        .absence-alert-item {
            background-color: rgba(255, 193, 7, 0.2);
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .absence-alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .absence-alert-actions {
            display: flex;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .attendance-stats {
                flex-direction: column;
            }

            .attendance-stat-item {
                width: 100%;
            }

            .attendance-user-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .attendance-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .birthday-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .birthday-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .absence-alert-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .absence-alert-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }
    </style>
</head>

<body>
    <!-- Modal para WhatsApp -->
    <div class="modal fade" id="whatsappModal" tabindex="-1" aria-labelledby="whatsappModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="whatsappModalLabel"><i class="fab fa-whatsapp"></i> Enviar mensaje por
                        WhatsApp</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body whatsapp-modal">
                    <div class="mb-3">
                        <label for="whatsappNumber" class="form-label">Número de teléfono *</label>
                        <input type="tel" class="form-control" id="whatsappNumber" placeholder="3001234567" required>
                        <div class="phone-validation-error" id="whatsappPhoneError">Formato inválido. Use 10 dígitos sin
                            espacios ni símbolos.</div>
                    </div>
                    <div class="mb-3">
                        <label for="whatsappMessage" class="form-label">Mensaje personalizado *</label>
                        <textarea class="form-control" id="whatsappMessage" rows="4" required></textarea>
                    </div>
                    <div class="message-preview">
                        <strong>Vista previa:</strong>
                        <div id="messagePreview"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <a id="whatsappLink" class="btn btn-success" target="_blank">
                        <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar usuario -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="editUserModalLabel"><i class="fas fa-user-edit"></i> Editar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editName" class="form-label">Nombre completo *</label>
                                <input type="text" class="form-control" id="editName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editDocument" class="form-label">Documento *</label>
                                <input type="text" class="form-control" id="editDocument" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editBirthdate" class="form-label">Fecha de nacimiento</label>
                                <input type="date" class="form-control" id="editBirthdate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editPhone" class="form-label">Teléfono *</label>
                                <input type="tel" class="form-control" id="editPhone" placeholder="3001234567" required>
                                <div class="phone-validation-error" id="editPhoneError">Formato inválido. Use 10 dígitos
                                    sin espacios ni símbolos.</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editEps" class="form-label">EPS</label>
                                <input type="text" class="form-control" id="editEps">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editRh" class="form-label">RH *</label>
                                <select class="form-select" id="editRh" required>
                                    <option value="">Seleccionar tipo de sangre</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editPathology" class="form-label">Patología</label>
                                <input type="text" class="form-control" id="editPathology">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editEmergencyContact" class="form-label">Contacto de emergencia *</label>
                                <input type="text" class="form-control" id="editEmergencyContact" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editEmergencyPhone" class="form-label">Teléfono de emergencia *</label>
                                <input type="tel" class="form-control" id="editEmergencyPhone" placeholder="3001234567"
                                    required>
                                <div class="phone-validation-error" id="editEmergencyPhoneError">Formato inválido. Use
                                    10 dígitos sin espacios ni símbolos.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editClassTime" class="form-label">Clase habitual *</label>
                                <select class="form-select" id="editClassTime" required>
                                    <option value="">Seleccionar clase</option>
                                    <option value="5:00 am">5:00 am</option>
                                    <option value="6:00 am">6:00 am</option>
                                    <option value="7:00 am">7:00 am</option>
                                    <option value="8:00 am">8:00 am</option>
                                    <option value="4:00 pm">4:00 pm</option>
                                    <option value="5:30 pm">5:30 pm</option>
                                    <option value="6:30 pm">6:30 pm</option>
                                    <option value="7:30 pm">7:30 pm</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editAffiliationType" class="form-label">Tipo de afiliación *</label>
                                <select class="form-select" id="editAffiliationType" required>
                                    <option value="">Seleccionar tipo</option>
                                    <option value="mensualidad">Mensualidad</option>
                                    <option value="paquete 10 clases">Paquete 10 clases</option>
                                    <option value="personalizado Diana">Personalizado Diana</option>
                                    <option value="clase suelta">Clase suelta</option>
                                    <option value="pole">Pole</option>
                                    <option value="telas">Telas</option>
                                    <option value="gap">GAP</option>
                                    <option value="flex">FLEX</option>
                                    <option value="Entrenador(a)">Entrenador(a)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editStatus" class="form-label">Estado *</label>
                                <select class="form-select" id="editStatus" required>
                                    <option value="active">Activo</option>
                                    <option value="inactive">Inactivo</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveEditUser">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para información de emergencia -->
    <div class="modal fade" id="emergencyInfoModal" tabindex="-1" aria-labelledby="emergencyInfoModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="emergenceInfoModalLabel"><i class="fas fa-first-aid"></i> Información de
                        Emergencia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="emergencyInfoContent">
                        <!-- La información se cargará aquí dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para confirmación de pago -->
    <div class="modal fade" id="paymentConfirmationModal" tabindex="-1" aria-labelledby="paymentConfirmationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="paymentConfirmationModalLabel"><i class="fas fa-check-circle"></i> Pago
                        Registrado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>El pago se ha registrado correctamente. ¿Desea enviar un mensaje de confirmación por WhatsApp?
                    </p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sendWhatsAppConfirmation" checked>
                        <label class="form-check-label" for="sendWhatsAppConfirmation">
                            Enviar mensaje de confirmación
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" id="sendConfirmationBtn">
                        <i class="fab fa-whatsapp"></i> Enviar Confirmación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para formulario WhatsApp -->
    <div class="modal fade" id="whatsappFormModal" tabindex="-1" aria-labelledby="whatsappFormModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="whatsappFormModalLabel"><i class="fab fa-whatsapp"></i> Formulario de
                        Recolección de Datos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Este formulario genera un mensaje para solicitar datos a
                        nuevos usuarios por WhatsApp.
                    </div>
                    <form id="whatsappDataForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="clientName" class="form-label">Nombre del Cliente</label>
                                <input type="text" class="form-control" id="clientName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="clientPhone" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="clientPhone" placeholder="3001234567">
                                <div class="phone-validation-error" id="clientPhoneError">Formato inválido. Use 10
                                    dígitos sin espacios ni símbolos.</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="whatsappGroupLink" class="form-label">Enlace del Grupo de WhatsApp</label>
                            <input type="url" class="form-control" id="whatsappGroupLink"
                                value="https://chat.whatsapp.com/DSJzYAb6h58FQDA8yEAzwN"
                                placeholder="https://chat.whatsapp.com/...">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="includeGroupLink" checked>
                            <label class="form-check-label" for="includeGroupLink">
                                Incluir enlace al grupo en el mensaje
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="includeGoogleForm" checked>
                            <label class="form-check-label" for="includeGoogleForm">
                                Incluir enlace al formulario de Google
                            </label>
                        </div>
                    </form>
                    <div class="whatsapp-survey">
                        <h6>Vista previa del mensaje:</h6>
                        <div id="whatsappFormPreview" class="message-preview">
                            El mensaje se generará automáticamente...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <a id="whatsappFormLink" class="btn btn-success" target="_blank">
                        <i class="fab fa-whatsapp"></i> Abrir en WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para resumen de importación -->
    <div class="modal fade" id="importSummaryModal" tabindex="-1" aria-labelledby="importSummaryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="importSummaryModalLabel"><i class="fas fa-file-import"></i> Resumen de
                        Importación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="importSummaryContent">
                        <!-- El resumen se cargará aquí dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="confirmImportBtn">Confirmar Importación</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cumpleaños -->
    <div class="modal fade" id="birthdayModal" tabindex="-1" aria-labelledby="birthdayModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="birthdayModalLabel"><i class="fas fa-birthday-cake"></i> <span
                            id="birthdayModalTitle">Cumpleaños</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="birthdayContent">
                        <!-- La lista de cumpleaños se cargará aquí dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" id="sendBirthdayWishes">
                        <i class="fab fa-whatsapp"></i> Enviar Felicitaciones
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="text-center flex-grow-1 mb-4" style="color: var(--color-primary);">Sistema de Gestión Antología
                Box23</h1>
            <img src="antologia_logo.png" alt="Logo Antología Box23" class="img-fluid" style="max-height: 100px;">
        </div>

        <!-- Sección de restauración automática -->
        <div id="autorestoreSection" class="autorestore-section d-none">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5><i class="fas fa-sync-alt"></i> Restauración automática de datos</h5>
                    <p class="mb-0">Se encontró un archivo de respaldo previo. ¿Desea restaurar los datos?</p>
                </div>
                <div>
                    <button id="restoreAutoBtn" class="btn btn-success me-2">
                        <i class="fas fa-check"></i> Sí, restaurar
                    </button>
                    <button id="skipRestoreBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> No, empezar nuevo
                    </button>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users"
                    type="button" role="tab">Usuarios</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance"
                    type="button" role="tab">Asistencias</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="income-tab" data-bs-toggle="tab" data-bs-target="#income" type="button"
                    role="tab">Pagos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button"
                    role="tab">Reportes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button"
                    role="tab">Datos</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Sección de Registro de Usuarios -->
            <div class="tab-pane fade show active" id="users" role="tabpanel">
                <div class="row">
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-user-plus"></i> Registrar Nuevo Usuario
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="userForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="name" class="form-label">Nombre completo *</label>
                                            <input type="text" class="form-control" id="name" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="document" class="form-label">Documento *</label>
                                            <input type="text" class="form-control" id="document" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="birthdate" class="form-label">Fecha de nacimiento</label>
                                            <input type="date" class="form-control" id="birthdate">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="phone" class="form-label">Teléfono *</label>
                                            <input type="tel" class="form-control" id="phone" placeholder="3001234567"
                                                required>
                                            <div class="phone-validation-error" id="phoneError">Formato inválido. Use 10
                                                dígitos sin espacios ni símbolos.</div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="eps" class="form-label">EPS</label>
                                            <input type="text" class="form-control" id="eps">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="rh" class="form-label">RH *</label>
                                            <select class="form-select" id="rh" required>
                                                <option value="">Seleccionar tipo de sangre</option>
                                                <option value="A+">A+</option>
                                                <option value="A-">A-</option>
                                                <option value="B+">B+</option>
                                                <option value="B-">B-</option>
                                                <option value="AB+">AB+</option>
                                                <option value="AB-">AB-</option>
                                                <option value="O+">O+</option>
                                                <option value="O-">O-</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="pathology" class="form-label">Patología</label>
                                            <input type="text" class="form-control" id="pathology">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="emergencyContact" class="form-label">Contacto de emergencia
                                                *</label>
                                            <input type="text" class="form-control" id="emergencyContact" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="emergencyPhone" class="form-label">Teléfono de emergencia
                                                *</label>
                                            <input type="tel" class="form-control" id="emergencyPhone"
                                                placeholder="3001234567" required>
                                            <div class="phone-validation-error" id="emergencyPhoneError">Formato
                                                inválido. Use 10 dígitos sin espacios ni símbolos.</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="classTime" class="form-label">Clase habitual *</label>
                                            <select class="form-select" id="classTime" required>
                                                <option value="">Seleccionar clase</option>
                                                <option value="5:00 am">5:00 am</option>
                                                <option value="6:00 am">6:00 am</option>
                                                <option value="7:00 am">7:00 am</option>
                                                <option value="8:00 am">8:00 am</option>
                                                <option value="4:00 pm">4:00 pm</option>
                                                <option value="5:30 pm">5:30 pm</option>
                                                <option value="6:30 pm">6:30 pm</option>
                                                <option value="7:30 pm">7:30 pm</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="affiliationType" class="form-label">Tipo de afiliación *</label>
                                            <select class="form-select" id="affiliationType" required>
                                                <option value="">Seleccionar tipo</option>
                                                <option value="mensualidad">Mensualidad</option>
                                                <option value="paquete 10 clases">Paquete 10 clases</option>
                                                <option value="personalizado Diana">Personalizado Diana</option>
                                                <option value="clase suelta">Clase suelta</option>
                                                <option value="pole">Pole</option>
                                                <option value="gap">GAP</option>
                                                <option value="flex">FLEX</option>
                                                <option value="telas">Telas</option>
                                                <option value="Entrenador(a)">Entrenador(a)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="status" class="form-label">Estado *</label>
                                            <select class="form-select" id="status" required>
                                                <option value="active">Activo</option>
                                                <option value="inactive">Inactivo</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">Guardar Usuario</button>
                                </form>
                                <div class="mt-3 text-center">
                                    <button class="btn btn-outline-info" id="openWhatsAppForm">
                                        <i class="fab fa-whatsapp"></i> Generar formulario para WhatsApp
                                    </button>
                                    <div class="mt-2">
                                        <small class="text-muted">O utiliza nuestro <a
                                                href="https://forms.gle/ZHUj1Q7YiDhE5P498" target="_blank"
                                                class="google-form-link">formulario de Google</a> para recopilar
                                            información</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0"><i class="fas fa-users"></i> Usuarios Registrados</h5>
                                <button class="btn btn-sm btn-outline-warning" id="showBirthdaysThisMonth">
                                    <i class="fas fa-birthday-cake"></i> Cumpleaños del Mes
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="search-box">
                                    <input type="text" class="form-control" id="searchUserInput"
                                        placeholder="Buscar usuario por nombre, documento o información de emergencia...">
                                </div>
                                <div class="table-responsive table-container">
                                    <table class="table table-striped table-hover" id="usersTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nombre</th>
                                                <th>Documento</th>
                                                <th>Teléfono</th>
                                                <th>Clase</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersList">
                                            <!-- Los usuarios se cargarán aquí dinámicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Registro de Asistencias - MEJORADA -->
            <div class="tab-pane fade" id="attendance" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-calendar-check"></i> Registrar Asistencias
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="attendanceDate" class="form-label">Fecha *</label>
                                        <input type="date" class="form-control" id="attendanceDate" required>
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button class="btn btn-outline-primary w-100" id="refreshAttendance">
                                            <i class="fas fa-sync-alt"></i> Actualizar Lista
                                        </button>
                                    </div>
                                </div>

                                <div class="attendance-stats mb-4">
                                    <div class="attendance-stat-item">
                                        <div class="attendance-stat-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="attendance-stat-content">
                                            <h5 id="totalUsersCount">0</h5>
                                            <p>Usuarios Activos</p>
                                        </div>
                                    </div>
                                    <div class="attendance-stat-item">
                                        <div class="attendance-stat-icon">
                                            <i class="fas fa-user-check"></i>
                                        </div>
                                        <div class="attendance-stat-content">
                                            <h5 id="presentUsersCount">0</h5>
                                            <p>Asistencias Hoy</p>
                                        </div>
                                    </div>
                                    <div class="attendance-stat-item">
                                        <div class="attendance-stat-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <div class="attendance-stat-content">
                                            <h5 id="pendingUsersCount">0</h5>
                                            <p>Pendientes</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="attendance-quick-actions">
                                    <button class="btn btn-outline-success" id="markAllPresent">
                                        <i class="fas fa-check-circle"></i> Marcar Todos Presentes
                                    </button>
                                    <button class="btn btn-outline-secondary" id="clearAllAttendance">
                                        <i class="fas fa-times-circle"></i> Limpiar Todo
                                    </button>
                                </div>

                                <!-- BUSCADOR MEJORADO PARA ASISTENCIA -->
                                <div class="search-box mb-3">
                                    <input type="text" class="form-control" id="attendanceSearchInput"
                                        placeholder="Buscar usuario por nombre...">
                                </div>

                                <!-- Nueva lista de usuarios para asistencia (orden alfabético) -->
                                <div class="attendance-user-list">
                                    <div id="attendanceUsersList">
                                        <!-- Los usuarios se cargarán aquí dinámicamente en orden alfabético -->
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <button class="btn btn-success w-100" id="saveAttendance">
                                        <i class="fas fa-save"></i> Guardar Todas las Asistencias
                                    </button>
                                </div>

                                <div class="mt-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0"><i class="fas fa-list"></i> Historial de
                                                Asistencias</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="attendance-filters">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label for="attendanceStartDateFilter" class="form-label">Fecha
                                                            inicial</label>
                                                        <input type="date" class="form-control"
                                                            id="attendanceStartDateFilter">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="attendanceEndDateFilter" class="form-label">Fecha
                                                            final</label>
                                                        <input type="date" class="form-control"
                                                            id="attendanceEndDateFilter">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="attendanceUserFilter"
                                                            class="form-label">Usuario</label>
                                                        <select class="form-select" id="attendanceUserFilter">
                                                            <option value="">Todos los usuarios</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3 d-flex align-items-end">
                                                        <button class="btn btn-primary w-100"
                                                            id="filterAttendanceBtn">Filtrar</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="table-responsive table-container">
                                                <table class="table table-striped table-hover" id="attendanceTable">
                                                    <thead>
                                                        <tr>
                                                            <th>Fecha</th>
                                                            <th>Usuario</th>
                                                            <th>Clase</th>
                                                            <th>Estado</th>
                                                            <th>Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="attendanceList">
                                                        <!-- Las asistencias se cargarán aquí dinámicamente -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Alerta de inasistencias consecutivas -->
                                <div class="card mt-4">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="card-title mb-0"><i class="fas fa-exclamation-triangle"></i> Alertas
                                            de Inasistencias</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="absenceAlertsList">
                                            <!-- Las alertas se cargarán aquí dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Registro de Pagos -->
            <div class="tab-pane fade" id="income" role="tabpanel">
                <div class="row">
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-money-bill-wave"></i> Registrar Pago</h5>
                            </div>
                            <div class="card-body">
                                <form id="incomeForm">
                                    <!-- BUSCADOR MEJORADO PARA PAGOS -->
                                    <div class="mb-3">
                                        <label for="incomeUserSearch" class="form-label">Buscar usuario</label>
                                        <input type="text" class="form-control" id="incomeUserSearch"
                                            placeholder="Escriba nombre, documento o clase...">
                                    </div>
                                    <div class="mb-3">
                                        <label for="incomeUserSelect" class="form-label">Usuario *</label>
                                        <select class="form-select" id="incomeUserSelect" required>
                                            <option value="">Seleccionar usuario</option>
                                        </select>
                                    </div>
                                    <div class="date-range">
                                        <h6 class="mb-3">Rango de vigencia</h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="startDate" class="form-label">Fecha inicial *</label>
                                                <input type="date" class="form-control" id="startDate" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="endDate" class="form-label">Fecha final *</label>
                                                <input type="date" class="form-control" id="endDate" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="paymentMethod" class="form-label">Medio de pago *</label>
                                        <select class="form-select" id="paymentMethod" required>
                                            <option value="">Seleccionar medio</option>
                                            <option value="efectivo">Efectivo</option>
                                            <option value="transferencia">Transferencia</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="amount" class="form-label">Monto ($) *</label>
                                        <input type="number" step="0.01" class="form-control" id="amount" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Descripción</label>
                                        <textarea class="form-control" id="description" rows="2"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Registrar Pago</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-chart-line"></i> Registro de Pagos</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="incomeStartDateFilter" class="form-label">Fecha inicial</label>
                                        <input type="date" class="form-control" id="incomeStartDateFilter">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="incomeEndDateFilter" class="form-label">Fecha final</label>
                                        <input type="date" class="form-control" id="incomeEndDateFilter">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="incomeFilterUser" class="form-label">Usuario</label>
                                        <select class="form-select" id="incomeFilterUser">
                                            <option value="">Todos los usuarios</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <button class="btn btn-primary w-100" id="filterIncomeBtn">Filtrar</button>
                                    </div>
                                </div>
                                <div class="table-responsive table-container">
                                    <table class="table table-striped table-hover" id="incomeTable">
                                        <thead>
                                            <tr>
                                                <th>Fecha Pago</th>
                                                <th>Usuario</th>
                                                <th>Monto</th>
                                                <th>Método</th>
                                                <th>Válido hasta</th>
                                                <th>Descripción</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="incomeList">
                                            <!-- Los pagos se cargarán aquí dinámicamente -->
                                        </tbody>
                                        <tfoot>
                                            <tr class="total-row">
                                                <td colspan="2"><strong>Total</strong></td>
                                                <td><strong id="incomeTotal">$0.00</strong></td>
                                                <td colspan="4"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div id="packageWarning" class="alert mt-3 d-none package-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span id="warningText"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Reportes -->
            <div class="tab-pane fade" id="reports" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-chart-pie"></i> Reportes y Estadísticas
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="reportTotalUsers">0</h5>
                                                <p class="card-text">Usuarios activos</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="reportTotalIncome">$0</h5>
                                                <p class="card-text">Ingresos mensuales</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="reportAttendanceRate">0%</h5>
                                                <p class="card-text">Tasa de asistencia</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="reportPackagesCompleted">0</h5>
                                                <p class="card-text">Paquetes completados</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">Distribución por tipo de afiliación</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="chart-container">
                                                    <canvas id="affiliationChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">Asistencia por clase</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="chart-container">
                                                    <canvas id="attendanceChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Reporte detallado</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-3">
                                                <label for="reportStartDate" class="form-label">Fecha inicial</label>
                                                <input type="date" class="form-control" id="reportStartDate">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="reportEndDate" class="form-label">Fecha final</label>
                                                <input type="date" class="form-control" id="reportEndDate">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="reportType" class="form-label">Tipo de reporte</label>
                                                <select class="form-select" id="reportType">
                                                    <option value="attendance">Asistencias</option>
                                                    <option value="income">Pagos</option>
                                                    <option value="users">Usuarios</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-primary w-100" id="generateReportBtn">
                                                    <i class="fas fa-download"></i> Generar Reporte
                                                </button>
                                            </div>
                                        </div>
                                        <div class="table-responsive table-container">
                                            <table class="table table-striped table-hover" id="reportTable">
                                                <thead>
                                                    <tr>
                                                        <th>Fecha</th>
                                                        <th>Descripción</th>
                                                        <th>Usuario</th>
                                                        <th>Monto/Estado</th>
                                                        <th>Detalles</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="reportList">
                                                    <!-- Los reportes se cargarán aquí dinámicamente -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Gestión de Datos -->
            <div class="tab-pane fade" id="data" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card import-export-card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-database"></i> Respaldo de Datos</h5>
                            </div>
                            <div class="card-body text-center">
                                <p class="card-text">Realice una copia de seguridad de todos los datos del sistema</p>
                                <button class="btn btn-success mb-3" id="backupData">
                                    <i class="fas fa-download"></i> Descargar Respaldo Completo
                                </button>
                                <p class="text-muted">Se descargará un archivo Excel con todos los datos actuales</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card import-export-card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-upload"></i> Restaurar Datos</h5>
                            </div>
                            <div class="card-body text-center">
                                <p class="card-text">Restaurar datos desde un archivo Excel previamente exportado</p>
                                <div class="file-input-container btn btn-primary mb-2">
                                    <i class="fas fa-file-excel"></i> Seleccionar archivo Excel
                                    <input type="file" id="restoreFile" class="file-input" accept=".xlsx, .xls">
                                </div>
                                <div id="selectedFileName" class="text-muted mt-2">Ningún archivo seleccionado</div>
                                <button class="btn btn-warning mt-3" id="restoreData" disabled>
                                    <i class="fas fa-upload"></i> Restaurar Datos
                                </button>
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="replaceData">
                                    <label class="form-check-label" for="replaceData">
                                        Reemplazar datos existentes
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-info-circle"></i> Información del Sistema
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoUsers">0</h5>
                                                <p class="card-text">Usuarios registrados</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoAttendance">0</h5>
                                                <p class="card-text">Registros de asistencia</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoIncome">0</h5>
                                                <p class="card-text">Registros de pagos</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoLastBackup">Nunca</h5>
                                                <p class="card-text">Último respaldo</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-warning mt-4">
                                    <h6><i class="fas fa-exclamation-triangle"></i> Importante</h6>
                                    <p>Los datos se almacenan localmente en su navegador. Para evitar pérdida de
                                        información:</p>
                                    <ol>
                                        <li>Realice respaldos regularmente</li>
                                        <li>Guarde los archivos de respaldo en un lugar seguro</li>
                                        <li>Si cambia de dispositivo o navegador, deberá restaurar los datos desde un
                                            archivo</li>
                                    </ol>
                                </div>

                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="autoBackupCheckbox">
                                    <label class="form-check-label" for="autoBackupCheckbox">
                                        Realizar respaldo automático cada 15 minutos
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Sección de Respaldo en la Nube - Neon PostgreSQL -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #7C77B9, #1D8A99);">
                        <h5 class="card-title mb-0"><i class="fas fa-cloud"></i> Respaldo en la Nube (Neon PostgreSQL)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Respaldo automático en base de datos segura</strong><br>
                            Tus datos se respaldan automáticamente en Neon PostgreSQL cada vez que guardas cambios.
                            Los respaldos en la nube te permiten recuperar tus datos desde cualquier dispositivo.
                        </div>

                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <button class="btn btn-success w-100" id="manualBackupBtn">
                                    <i class="fas fa-cloud-upload-alt"></i> Respaldar Manualmente
                                </button>
                                <small class="text-muted">Forzar respaldo inmediato</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <button class="btn btn-warning w-100" id="restoreCloudBtn">
                                    <i class="fas fa-cloud-download-alt"></i> Restaurar desde Nube
                                </button>
                                <small class="text-muted">Recuperar último respaldo</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <button class="btn btn-info w-100" id="checkCloudStatusBtn">
                                    <i class="fas fa-sync-alt"></i> Verificar Estado
                                </button>
                                <small class="text-muted">Comprobar conexión</small>
                            </div>
                        </div>

                        <div class="mt-3 p-3" style="background-color: rgba(39, 249, 212, 0.1); border-radius: 8px;">
                            <h6><i class="fas fa-database"></i> Estado de la Nube</h6>
                            <div id="cloudStatus">
                                <p class="mb-1"><span id="cloudStatusIcon">🔵</span> <span
                                        id="cloudStatusText">Conectado a Neon PostgreSQL</span></p>
                                <p class="mb-1">💾 Respaldo automático: <strong>ACTIVADO</strong></p>
                                <p class="mb-0">🕒 Última sincronización: <span id="lastCloudSync">Nunca</span></p>
                            </div>
                        </div>

                        <!-- Historial de respaldos -->
                        <div class="mt-3">
                            <h6><i class="fas fa-history"></i> Últimos Respaldos</h6>
                            <div id="backupHistory" class="text-muted">
                                <small>Los respaldos se mostrarán aquí...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button class="btn btn-success rounded-circle p-3" id="exportBtn" data-bs-toggle="tooltip"
            data-bs-placement="left" title="Exportar a Excel">
            <i class="fas fa-file-excel fa-2x"></i>
        </button>
    </div>

    <!-- Notificación de respaldo automático -->
    <div class="backup-notification" id="backupNotification">
        <i class="fas fa-info-circle me-2"></i>
        <span id="backupNotificationText">Respaldo automático realizado</span>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Almacenamiento de datos
        let users = [];
        let attendance = [];
        let income = [];
        let lastBackup = 'Nunca';
        let autoBackupInterval = null;

        // Almacenamiento temporal para los datos del pago
        let pendingPaymentData = null;

        // Almacenamiento temporal para datos de importación
        let importData = {
            users: [],
            attendance: [],
            income: [],
            summary: {
                users: { success: 0, warnings: 0, errors: 0 },
                attendance: { success: 0, warnings: 0, errors: 0 },
                income: { success: 0, warnings: 0, errors: 0 }
            }
        };

        // Clases disponibles
        const classTimes = ["5:00 am", "6:00 am", "7:00 am", "8:00 am", "4:00 pm", "5:30 pm", "6:30 pm", "7:30 pm"];

        // Elementos DOM
        const userForm = document.getElementById('userForm');
        const incomeForm = document.getElementById('incomeForm');
        const usersList = document.getElementById('usersList');
        const attendanceList = document.getElementById('attendanceList');
        const incomeList = document.getElementById('incomeList');
        const userSelect = document.getElementById('incomeUserSelect');
        const incomeFilterUser = document.getElementById('incomeFilterUser');
        const exportBtn = document.getElementById('exportBtn');
        const saveAttendanceBtn = document.getElementById('saveAttendance');
        const packageWarning = document.getElementById('packageWarning');
        const warningText = document.getElementById('warningText');
        const backupDataBtn = document.getElementById('backupData');
        const restoreDataBtn = document.getElementById('restoreData');
        const restoreFileInput = document.getElementById('restoreFile');
        const selectedFileName = document.getElementById('selectedFileName');
        const replaceDataCheckbox = document.getElementById('replaceData');
        const autorestoreSection = document.getElementById('autorestoreSection');
        const restoreAutoBtn = document.getElementById('restoreAutoBtn');
        const skipRestoreBtn = document.getElementById('skipRestoreBtn');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const autoBackupCheckbox = document.getElementById('autoBackupCheckbox');
        const backupNotification = document.getElementById('backupNotification');
        const backupNotificationText = document.getElementById('backupNotificationText');
        const openWhatsAppFormBtn = document.getElementById('openWhatsAppForm');
        const sendConfirmationBtn = document.getElementById('sendConfirmationBtn');
        const whatsappNumber = document.getElementById('whatsappNumber');
        const whatsappMessage = document.getElementById('whatsappMessage');
        const messagePreview = document.getElementById('messagePreview');
        const whatsappLink = document.getElementById('whatsappLink');
        const searchUserInput = document.getElementById('searchUserInput');
        const refreshAttendanceBtn = document.getElementById('refreshAttendance');
        const markAllPresentBtn = document.getElementById('markAllPresent');
        const clearAllAttendanceBtn = document.getElementById('clearAllAttendance');
        const totalUsersCount = document.getElementById('totalUsersCount');
        const presentUsersCount = document.getElementById('presentUsersCount');
        const pendingUsersCount = document.getElementById('pendingUsersCount');
        const importSummaryModal = document.getElementById('importSummaryModal');
        const importSummaryContent = document.getElementById('importSummaryContent');
        const confirmImportBtn = document.getElementById('confirmImportBtn');
        const showBirthdaysThisMonthBtn = document.getElementById('showBirthdaysThisMonth');
        const sendBirthdayWishesBtn = document.getElementById('sendBirthdayWishes');
        const birthdayModalTitle = document.getElementById('birthdayModalTitle');
        const birthdayContent = document.getElementById('birthdayContent');
        const absenceAlertsList = document.getElementById('absenceAlertsList');

        // Variables para gráficos
        let affiliationChart = null;
        let attendanceChart = null;

        // Inicializar la aplicación
        function initializeApp() {
            console.log("Inicializando aplicación...");

            // Cargar datos desde localStorage
            loadFromLocalStorage();
            // =============================================

            // FUNCIONES PARA NEON POSTGRESQL - RESPALDOS EN LA NUBE
            // =============================================

            // Función para respaldar datos en Neon
            async function backupToNeon(data) {
                try {
                    console.log('Iniciando respaldo en Neon...');

                    const response = await fetch('/.netlify/functions/backup-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        console.log('✅ Respaldo en Neon exitoso:', result);
                        showBackupNotification('✅ Respaldo en la nube exitoso');
                        // Actualizar última sincronización en la UI
                        document.getElementById('lastCloudSync').textContent = new Date().toLocaleString();
                        return result;
                    } else {
                        console.error('❌ Error en respaldo Neon:', result.error);
                        showBackupNotification('❌ Error en respaldo en la nube');
                        return null;
                    }
                } catch (error) {
                    console.error('❌ Error conectando con Neon:', error);
                    // Silencioso - no afecta la experiencia del usuario
                    return null;
                }
            }

            // Función para restaurar datos desde Neon
            async function restoreFromNeon() {
                try {
                    console.log('Solicitando datos desde Neon...');

                    const response = await fetch('/.netlify/functions/restore-data');
                    const result = await response.json();

                    if (result.success) {
                        console.log('✅ Datos restaurados desde Neon:', result);
                        return result.data;
                    } else {
                        console.error('❌ Error restaurando desde Neon:', result.error);
                        alert('❌ No se pudieron restaurar los datos desde la nube: ' + result.error);
                        return null;
                    }
                } catch (error) {
                    console.error('❌ Error conectando con Neon:', error);
                    alert('❌ Error de conexión al restaurar desde la nube');
                    return null;
                }
            }

            // Función para obtener historial de respaldos
            async function getBackupHistory() {
                try {
                    const response = await fetch('/.netlify/functions/backup-history');
                    const result = await response.json();

                    if (result.success) {
                        return result.backups;
                    } else {
                        console.error('Error obteniendo historial:', result.error);
                        return [];
                    }
                } catch (error) {
                    console.error('Error obteniendo historial:', error);
                    return [];
                }
            }
            // Ejemplo para poner dentro de tu <script> en index.html
            async function probarConexion() {
                try {
                    const respuesta = await fetch('/api/usuarios'); // Llama a tu nuevo backend
                    const datos = await respuesta.json();
                    console.log("Datos recibidos de Neon:", datos);
                    alert("Conectado a Neon: " + JSON.stringify(datos));
                } catch (error) {
                    console.error("Error:", error);
                }
            }

// Puedes llamar a esta función en tu 'DOMContentLoaded' para probar.    
            // Configurar validación de teléfonos
            setupPhoneValidation();

            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;

            // Establecer fechas inicial y final para pagos (hoy y 30 días después)
            startDateInput.value = today;
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 30);
            endDateInput.value = endDate.toISOString().split('T')[0];

            // Configurar fecha inicial para filtros (inicio del mes)
            const firstDayOfMonth = new Date();
            firstDayOfMonth.setDate(1);
            const firstDayStr = firstDayOfMonth.toISOString().split('T')[0];

            document.getElementById('attendanceStartDateFilter').value = firstDayStr;
            document.getElementById('attendanceEndDateFilter').value = today;
            document.getElementById('incomeStartDateFilter').value = firstDayStr;
            document.getElementById('incomeEndDateFilter').value = today;
            document.getElementById('reportStartDate').value = firstDayStr;
            document.getElementById('reportEndDate').value = today;

            // Cargar datos
            loadUsers();
            loadAttendanceByClass();
            loadAttendance();
            loadIncome();
            updateSystemInfo();
            loadReports();

            // Configurar respaldo automático si estaba activado
            if (localStorage.getItem('autoBackupEnabled') === 'true') {
                autoBackupCheckbox.checked = true;
                startAutoBackup();
            }

            // Eventos para pestañas
            document.getElementById('attendance-tab').addEventListener('click', function () {
                loadAttendanceByClass();
                loadAttendance();
            });

            document.getElementById('income-tab').addEventListener('click', function () {
                loadIncome();
            });

            document.getElementById('reports-tab').addEventListener('click', function () {
                loadReports();
            });

            // Evento para cambio de fecha inicial en pagos
            startDateInput.addEventListener('change', function () {
                if (startDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 30);
                    endDateInput.value = endDate.toISOString().split('T')[0];
                }
            });
            // =============================================
            // EVENT LISTENERS PARA NEON - RESPALDOS EN LA NUBE
            // =============================================

            // Respaldar manualmente a la nube
            document.getElementById('manualBackupBtn').addEventListener('click', function () {
                const allData = {
                    users: users,
                    attendance: attendance,
                    income: income,
                    lastBackup: lastBackup,
                    totalRecords: {
                        users: users.length,
                        attendance: attendance.length,
                        income: income.length
                    }
                };

                // Mostrar loading
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Respaldando...';
                this.disabled = true;

                backupToNeon(allData).then(result => {
                    // Restaurar botón
                    this.innerHTML = originalText;
                    this.disabled = false;

                    if (result) {
                        alert(`✅ Respaldo manual exitoso!\n\nID: ${result.backupId}\nUsuarios: ${result.records.users}\nAsistencias: ${result.records.attendance}\nPagos: ${result.records.income}`);
                    } else {
                        alert('❌ Error en respaldo manual. Revisa la consola para más detalles.');
                    }
                });
            });

            // Restaurar desde la nube
            document.getElementById('restoreCloudBtn').addEventListener('click', async function () {
                if (confirm('¿Restaurar datos desde la nube?\n\n⚠️  ATENCIÓN: Esto reemplazará todos los datos locales actuales.\n¿Estás seguro de que deseas continuar?')) {

                    // Mostrar loading
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restaurando...';
                    this.disabled = true;

                    const cloudData = await restoreFromNeon();

                    // Restaurar botón
                    this.innerHTML = originalText;
                    this.disabled = false;

                    if (cloudData) {
                        // Actualizar datos locales
                        users = cloudData.users || users;
                        attendance = cloudData.attendance || attendance;
                        income = cloudData.income || income;
                        lastBackup = cloudData.lastBackup || lastBackup;

                        // Guardar en localStorage
                        saveToLocalStorage();

                        // Recargar todas las vistas
                        loadUsers();
                        loadAttendanceByClass();
                        loadAttendance();
                        loadIncome();
                        updateSystemInfo();

                        alert('✅ Datos restaurados desde la nube correctamente!\n\nSe han cargado todos los datos del último respaldo en la nube.');
                    }
                }
            });

            // Verificar estado de la nube
            document.getElementById('checkCloudStatusBtn').addEventListener('click', async function () {
                // Mostrar loading
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';

                // Simular verificación (podrías hacer un ping a una función)
                setTimeout(() => {
                    this.innerHTML = originalText;

                    // Actualizar estado en UI
                    document.getElementById('cloudStatusIcon').textContent = '🟢';
                    document.getElementById('cloudStatusText').textContent = 'Conexión exitosa - Neon PostgreSQL';
                    document.getElementById('lastCloudSync').textContent = new Date().toLocaleString();

                    showBackupNotification('✅ Conexión con la nube verificada correctamente');
                }, 1500);
            });

            // Evento para respaldo automático
            autoBackupCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    startAutoBackup();
                    localStorage.setItem('autoBackupEnabled', 'true');
                } else {
                    stopAutoBackup();
                    localStorage.setItem('autoBackupEnabled', 'false');
                }
            });

            // Evento para formulario de WhatsApp
            openWhatsAppFormBtn.addEventListener('click', function () {
                const whatsappFormModal = new bootstrap.Modal(document.getElementById('whatsappFormModal'));
                whatsappFormModal.show();
            });

            // Actualizar vista previa del formulario de WhatsApp
            document.getElementById('clientName').addEventListener('input', updateWhatsAppFormPreview);
            document.getElementById('clientPhone').addEventListener('input', updateWhatsAppFormPreview);
            document.getElementById('whatsappGroupLink').addEventListener('input', updateWhatsAppFormPreview);
            document.getElementById('includeGroupLink').addEventListener('change', updateWhatsAppFormPreview);
            document.getElementById('includeGoogleForm').addEventListener('change', updateWhatsAppFormPreview);

            // Configurar envío de confirmación de pago
            sendConfirmationBtn.addEventListener('click', function () {
                if (!pendingPaymentData) {
                    alert('No hay datos de pago pendientes.');
                    return;
                }

                // Registrar el pago ahora
                pendingPaymentData.id = Date.now();
                income.push(pendingPaymentData);
                saveToLocalStorage();

                // Recargar la lista de ingresos
                loadIncome();

                // Obtener el usuario para el mensaje de WhatsApp
                const selectedUser = users.find(u => u.id === pendingPaymentData.userId);

                if (selectedUser) {
                    // Validar teléfono
                    if (!isValidPhone(selectedUser.phone)) {
                        alert('No se puede enviar el mensaje porque el usuario no tiene un número de teléfono válido.');

                        // Cerrar modal de confirmación
                        const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentConfirmationModal'));
                        paymentModal.hide();

                        // Limpiar datos pendientes
                        pendingPaymentData = null;
                        return;
                    }

                    // Preparar y enviar mensaje de WhatsApp
                    const message = `Hola ${selectedUser.name}, tu pago en Antologia Box23 por un valor de $${pendingPaymentData.amount} por ${pendingPaymentData.paymentMethod} ha sido registrado exitosamente. Tu membresía es válida hasta el ${formatDate(pendingPaymentData.endDate)}. ¡Gracias por confiar en Antología Box23!`;

                    // Usar la función sendWhatsApp
                    sendWhatsApp(selectedUser.id, pendingPaymentData.amount, formatDate(pendingPaymentData.endDate));
                } else {
                    alert('No se puede enviar el mensaje porque no se encontró el usuario seleccionado.');
                }

                // Cerrar modal de confirmación
                const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentConfirmationModal'));
                paymentModal.hide();

                // Resetear el formulario
                incomeForm.reset();

                // Restablecer fechas por defecto
                const today = new Date().toISOString().split('T')[0];
                startDateInput.value = today;
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + 30);
                endDateInput.value = endDate.toISOString().split('T')[0];

                // Limpiar datos pendientes
                pendingPaymentData = null;
            });

            // También debemos manejar el caso en que el usuario cancele el envío del mensaje
            document.getElementById('paymentConfirmationModal').addEventListener('hidden.bs.modal', function () {
                // Si hay datos pendientes pero no se envió el mensaje, preguntar si se desea guardar igualmente
                if (pendingPaymentData) {
                    if (confirm('¿Desea registrar el pago sin enviar el mensaje de WhatsApp?')) {
                        // Registrar el pago
                        pendingPaymentData.id = Date.now();
                        income.push(pendingPaymentData);
                        saveToLocalStorage();

                        // Recargar la lista de ingresos
                        loadIncome();

                        // Resetear el formulario
                        incomeForm.reset();

                        // Restablecer fechas por defecto
                        const today = new Date().toISOString().split('T')[0];
                        startDateInput.value = today;
                        const endDate = new Date();
                        endDate.setDate(endDate.getDate() + 30);
                        endDateInput.value = endDate.toISOString().split('T')[0];
                    }

                    // Limpiar datos pendientes
                    pendingPaymentData = null;
                }
            });

            // Eventos para WhatsApp
            whatsappNumber.addEventListener('input', function () {
                if (this.value && !isValidPhone(this.value)) {
                    document.getElementById('whatsappPhoneError').style.display = 'block';
                    this.classList.add('validation-error');
                } else {
                    document.getElementById('whatsappPhoneError').style.display = 'none';
                    this.classList.remove('validation-error');
                }
                updateWhatsAppLink();
            });

            whatsappMessage.addEventListener('input', function () {
                messagePreview.textContent = this.value;
                updateWhatsAppLink();
            });

            // Configurar eventos de filtrado
            document.getElementById('filterAttendanceBtn').addEventListener('click', loadAttendance);
            document.getElementById('filterIncomeBtn').addEventListener('click', loadIncome);
            document.getElementById('generateReportBtn').addEventListener('click', loadReports);

            // Configurar búsqueda de usuarios
            searchUserInput.addEventListener('input', filterUsers);

            // Configurar evento antes de cerrar la ventana
            window.addEventListener('beforeunload', function (e) {
                if (localStorage.getItem('autoBackupEnabled') === 'true') {
                    createAutoBackup();
                    // Mensaje de confirmación personalizado no es posible en todos los navegadores
                    e.preventDefault();
                    e.returnValue = '¿Estás seguro de que quieres salir? Se realizará un respaldo automático de tus datos.';
                }
            });

            // Eventos para la nueva sección de asistencias
            refreshAttendanceBtn.addEventListener('click', function () {
                loadAttendanceByClass();
            });

            markAllPresentBtn.addEventListener('click', function () {
                const checkboxes = document.querySelectorAll('.attendance-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                updateAttendanceStats();
            });

            clearAllAttendanceBtn.addEventListener('click', function () {
                const checkboxes = document.querySelectorAll('.attendance-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateAttendanceStats();
            });

            document.getElementById('attendanceDate').addEventListener('change', function () {
                loadAttendanceByClass();
            });

            // NUEVO: Evento para el buscador de asistencia
            document.getElementById('attendanceSearchInput').addEventListener('input', filterAttendanceUsers);

            // Evento para confirmar importación
            confirmImportBtn.addEventListener('click', function () {
                confirmImport();
            });

            // Evento para restaurar datos
            restoreDataBtn.addEventListener('click', function () {
                // El preprocesamiento ya se hizo al seleccionar el archivo
                // Solo necesitamos asegurarnos de que hay datos para importar
                if (importData.users.length === 0 &&
                    importData.attendance.length === 0 &&
                    importData.income.length === 0) {
                    alert('No hay datos válidos para importar.');
                    return;
                }

                // El modal de resumen ya se muestra en preprocessImportData
            });

            // Evento para exportar a Excel
            exportBtn.addEventListener('click', function () {
                // Preparar datos para exportar
                let workbook = XLSX.utils.book_new();

                // Hoja de usuarios
                const usersData = users.map(user => ({
                    'ID': user.id,
                    'Nombre': user.name,
                    'Documento': user.document || '',
                    'Fecha Nacimiento': user.birthdate || '',
                    'Telefono': user.phone ? `'${user.phone}` : '', // Prefijar con ' para mantener formato texto
                    'EPS': user.eps || '',
                    'RH': user.rh || '',
                    'Patologia': user.pathology || '',
                    'Contacto Emergencia': user.emergencyContact || '',
                    'Telefono Emergencia': user.emergencyPhone ? `'${user.emergencyPhone}` : '',
                    'Clase': user.classTime || '',
                    'Tipo Afiliacion': user.affiliationType || '',
                    'Estado': user.status || '',
                    'Fecha Registro': user.createdAt ? new Date(user.createdAt).toLocaleDateString('es-ES') : ''
                }));

                const usersWorksheet = XLSX.utils.json_to_sheet(usersData);
                XLSX.utils.book_append_sheet(workbook, usersWorksheet, 'Usuarios');

                // Generar archivo Excel
                const fileName = `reporte_antologia_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);

                alert(`Reporte exportado correctamente como ${fileName}`);
            });

            // Evento para respaldo de datos
            backupDataBtn.addEventListener('click', function () {
                if (confirm('¿Está seguro de que desea descargar un respaldo completo de todos los datos?')) {
                    // Crear un libro de trabajo con todas las hojas
                    let workbook = XLSX.utils.book_new();

                    // Hoja de usuarios - CON NOMBRES CORRECTOS
                    const usersData = users.map(user => ({
                        'ID': user.id,
                        'Nombre': user.name,
                        'Documento': user.document || '',
                        'Fecha Nacimiento': user.birthdate || '',
                        'Telefono': user.phone ? `'${user.phone}` : '', // Prefijar con ' para mantener formato texto
                        'EPS': user.eps || '',
                        'RH': user.rh || '',
                        'Patologia': user.pathology || '',
                        'Contacto Emergencia': user.emergencyContact || '',
                        'Telefono Emergencia': user.emergencyPhone ? `'${user.emergencyPhone}` : '',
                        'Clase': user.classTime || '',
                        'Tipo Afiliacion': user.affiliationType || '',
                        'Estado': user.status || '',
                        'Fecha Registro': user.createdAt ? new Date(user.createdAt).toLocaleDateString('es-ES') : ''
                    }));

                    const usersWorksheet = XLSX.utils.json_to_sheet(usersData);
                    XLSX.utils.book_append_sheet(workbook, usersWorksheet, 'Usuarios');

                    // Hoja de asistencias - CON NOMBRES CORRECTOS
                    const attendanceData = attendance.map(record => {
                        const user = users.find(u => u.id === record.userId) || { name: 'Usuario eliminado' };
                        return {
                            'ID': record.id,
                            'UsuarioID': record.userId,
                            'Fecha': record.date,
                            'Usuario': user.name,
                            'Estado': record.status,
                            'Fecha Registro': record.registeredAt ? new Date(record.registeredAt).toLocaleDateString('es-ES') : ''
                        };
                    });

                    const attendanceWorksheet = XLSX.utils.json_to_sheet(attendanceData);
                    XLSX.utils.book_append_sheet(workbook, attendanceWorksheet, 'Asistencias');

                    // Hoja de pagos - CON NOMBRES CORRECTOS
                    const incomeData = income.map(record => {
                        const user = users.find(u => u.id === record.userId) || { name: 'Usuario eliminado' };
                        return {
                            'ID': record.id,
                            'UsuarioID': record.userId,
                            'Fecha Pago': record.paymentDate,
                            'Fecha Inicio': record.startDate,
                            'Fecha Fin': record.endDate,
                            'Usuario': user.name,
                            'Monto': parseFloat(record.amount || 0),
                            'Método Pago': record.paymentMethod || '',
                            'Descripción': record.description || '',
                            'Fecha Registro': record.registeredAt ? new Date(record.registeredAt).toLocaleDateString('es-ES') : ''
                        };
                    });

                    const incomeWorksheet = XLSX.utils.json_to_sheet(incomeData);
                    XLSX.utils.book_append_sheet(workbook, incomeWorksheet, 'Pagos');

                    // Hoja de metadatos
                    const metadata = [
                        { 'Tipo': 'Sistema', 'Valor': 'Antología Box23 - Sistema de Gestión', 'Fecha': new Date().toLocaleDateString('es-ES') },
                        { 'Tipo': 'Fecha respaldo', 'Valor': new Date().toLocaleString('es-ES'), 'Fecha': new Date().toLocaleDateString('es-ES') },
                        { 'Tipo': 'Total usuarios', 'Valor': users.length, 'Fecha': new Date().toLocaleDateString('es-ES') },
                        { 'Tipo': 'Total asistencias', 'Valor': attendance.length, 'Fecha': new Date().toLocaleDateString('es-ES') },
                        { 'Tipo': 'Total pagos', 'Valor': income.length, 'Fecha': new Date().toLocaleDateString('es-ES') }
                    ];

                    const metadataWorksheet = XLSX.utils.json_to_sheet(metadata);
                    XLSX.utils.book_append_sheet(workbook, metadataWorksheet, 'Metadatos');

                    // Generar archivo Excel
                    const fileName = `respaldo_antologia_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(workbook, fileName);

                    // Actualizar última fecha de respaldo
                    lastBackup = new Date().toLocaleString('es-ES');
                    localStorage.setItem('lastBackup', lastBackup);
                    updateSystemInfo();

                    alert(`Respaldo completo guardado como ${fileName}`);
                }
            });

            // Evento para restaurar automáticamente
            restoreAutoBtn.addEventListener('click', function () {
                // Restaurar desde el respaldo automático
                const backupKey = 'gymSystemBackup';
                const autoBackup = localStorage.getItem(backupKey);

                if (autoBackup) {
                    try {
                        const backupData = JSON.parse(autoBackup);

                        // Verificar que backupData tenga la estructura esperada
                        if (backupData.users && backupData.attendance && backupData.income) {
                            // Restaurar automáticamente
                            users = backupData.users || [];
                            attendance = backupData.attendance || [];
                            income = backupData.income || [];

                            saveToLocalStorage();

                            loadUsers();
                            loadAttendanceByClass();
                            loadAttendance();
                            loadIncome();
                            updateSystemInfo();
                            loadReports();

                            alert('Datos restaurados correctamente desde el respaldo automático.');
                        } else {
                            console.error('Estructura de respaldo automático inválida');
                            alert('El respaldo automático no tiene la estructura correcta.');
                        }
                    } catch (e) {
                        console.error('Error al analizar el respaldo automático:', e);
                        alert('Error al restaurar desde el respaldo automático.');
                    }
                }

                // Ocultar sección de restauración automática
                autorestoreSection.classList.add('d-none');
            });

            // Evento para saltar restauración automática
            skipRestoreBtn.addEventListener('click', function () {
                // Ocultar sección de restauración automática
                autorestoreSection.classList.add('d-none');
            });

            // Evento para selección de archivo de restauración
            restoreFileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    selectedFileName.textContent = file.name;
                    restoreDataBtn.disabled = false;

                    // Leer el archivo inmediatamente para preprocesar
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });

                            // Verificar que el archivo tenga las hojas necesarias
                            if (!workbook.SheetNames.includes('Usuarios') ||
                                !workbook.SheetNames.includes('Asistencias') ||
                                !workbook.SheetNames.includes('Pagos')) {
                                alert('El archivo seleccionado no es un respaldo válido del sistema.');
                                restoreDataBtn.disabled = true;
                                return;
                            }

                            // Preprocesar datos para mostrar resumen
                            preprocessImportData(workbook);

                        } catch (error) {
                            console.error('Error al leer el archivo:', error);
                            alert('Error al leer el archivo. Asegúrese de que es un archivo Excel válido.');
                            restoreDataBtn.disabled = true;
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    selectedFileName.textContent = 'Ningún archivo seleccionado';
                    restoreDataBtn.disabled = true;
                }
            });

            // Evento para formulario de usuario
            userForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Validar teléfonos
                const phone = document.getElementById('phone').value;
                const emergencyPhone = document.getElementById('emergencyPhone').value;

                if (!isValidPhone(phone)) {
                    alert('El formato del teléfono principal es inválido. Debe tener 10 dígitos y comenzar con 3.');
                    return;
                }

                if (!isValidPhone(emergencyPhone)) {
                    alert('El formato del teléfono de emergencia es inválido. Debe tener 10 dígitos y comenzar con 3.');
                    return;
                }

                const newUser = {
                    id: generateNextUserId(),
                    name: document.getElementById('name').value,
                    document: document.getElementById('document').value,
                    birthdate: document.getElementById('birthdate').value,
                    phone: phone,
                    eps: document.getElementById('eps').value,
                    rh: document.getElementById('rh').value,
                    pathology: document.getElementById('pathology').value,
                    emergencyContact: document.getElementById('emergencyContact').value,
                    emergencyPhone: emergencyPhone,
                    classTime: document.getElementById('classTime').value,
                    affiliationType: document.getElementById('affiliationType').value,
                    status: document.getElementById('status').value,
                    createdAt: new Date().toISOString()
                };

                users.push(newUser);
                saveToLocalStorage();

                loadUsers();
                userForm.reset();

                // Mostrar mensaje de éxito
                alert('Usuario registrado correctamente!');
            });

            // Evento para formulario de ingresos
            incomeForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Recoger los datos del formulario pero no guardarlos todavía
                pendingPaymentData = {
                    userId: userSelect.value,
                    paymentDate: new Date().toISOString().split('T')[0],
                    startDate: startDateInput.value,
                    endDate: endDateInput.value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    amount: parseFloat(document.getElementById('amount').value).toFixed(2),
                    description: document.getElementById('description').value,
                    registeredAt: new Date().toISOString()
                };

                // Validar que se haya seleccionado un usuario
                if (!pendingPaymentData.userId) {
                    alert('Por favor, seleccione un usuario.');
                    return;
                }

                // Mostrar modal de confirmación en lugar de registrar inmediatamente
                const paymentModal = new bootstrap.Modal(document.getElementById('paymentConfirmationModal'));
                paymentModal.show();
            });

            // Evento para guardar asistencias
            saveAttendanceBtn.addEventListener('click', function () {
                const attendanceDate = document.getElementById('attendanceDate').value;
                const checkboxes = document.querySelectorAll('.attendance-checkbox');
                let savedCount = 0;

                // Eliminar asistencias previas para esta fecha
                attendance = attendance.filter(a => a.date !== attendanceDate);

                checkboxes.forEach(checkbox => {
                    const userId = checkbox.dataset.userId;
                    const isPresent = checkbox.checked;

                    if (isPresent) {
                        attendance.push({
                            id: Date.now() + savedCount,
                            userId: userId,
                            date: attendanceDate,
                            status: 'presente',
                            registeredAt: new Date().toISOString()
                        });
                        savedCount++;
                    }
                });

                saveToLocalStorage();
                loadAttendanceByClass();
                loadAttendance();
                updateSystemInfo();

                alert(`Asistencias guardadas correctamente. Total: ${savedCount}`);
            });

            // Evento para mostrar cumpleaños del mes
            showBirthdaysThisMonthBtn.addEventListener('click', function () {
                showBirthdays('month');
            });

            // Evento para enviar felicitaciones de cumpleaños
            sendBirthdayWishesBtn.addEventListener('click', function () {
                sendBirthdayWishes();
            });

            console.log("Aplicación inicializada correctamente");

            // En la función initializeApp, al final de los event listeners, agrega:
            // Verificar estado inicial de la nube
            setTimeout(() => {
                document.getElementById('checkCloudStatusBtn').click();
            }, 3000);
        }

        // Función para cargar datos desde localStorage
        function loadFromLocalStorage() {
            try {
                const usersData = localStorage.getItem('users');
                const attendanceData = localStorage.getItem('attendance');
                const incomeData = localStorage.getItem('income');
                const lastBackupData = localStorage.getItem('lastBackup');

                users = usersData ? JSON.parse(usersData) : [];
                attendance = attendanceData ? JSON.parse(attendanceData) : [];
                income = incomeData ? JSON.parse(incomeData) : [];
                lastBackup = lastBackupData || 'Nunca';

                console.log("Datos cargados desde localStorage:", {
                    users: users.length,
                    attendance: attendance.length,
                    income: income.length
                });
            } catch (error) {
                console.error("Error al cargar datos desde localStorage:", error);
                // Inicializar con arrays vacíos si hay error
                users = [];
                attendance = [];
                income = [];
                lastBackup = 'Nunca';
            }
        }

        // Función para guardar datos en localStorage
        // Función para guardar datos en localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('attendance', JSON.stringify(attendance));
                localStorage.setItem('income', JSON.stringify(income));
                localStorage.setItem('lastBackup', lastBackup);

                console.log("Datos guardados en localStorage");

                // ✅ NUEVO: Backup automático en Neon (en segundo plano)
                const allData = {
                    users: users,
                    attendance: attendance,
                    income: income,
                    lastBackup: lastBackup,
                    totalRecords: {
                        users: users.length,
                        attendance: attendance.length,
                        income: income.length
                    }
                };

                // Backup en segundo plano (no bloqueante)
                setTimeout(() => {
                    backupToNeon(allData).then(result => {
                        if (result) {
                            console.log('Backup en nube completado:', result);
                        }
                    });
                }, 1000);

            } catch (error) {
                console.error("Error al guardar datos en localStorage:", error);
            }
        }

        // Función para generar ID consecutivo ATG0001
        function generateNextUserId() {
            // Obtener el último ID utilizado
            let lastId = parseInt(localStorage.getItem('lastUserId')) || 0;

            // Buscar el máximo ID en los usuarios existentes
            if (users.length > 0) {
                const maxId = Math.max(...users.map(user => {
                    if (user.id && user.id.startsWith('ATG')) {
                        const idNum = parseInt(user.id.substring(3));
                        return isNaN(idNum) ? 0 : idNum;
                    }
                    return 0;
                }));
                lastId = Math.max(lastId, maxId);
            }

            // Generar nuevo ID
            const newId = lastId + 1;
            localStorage.setItem('lastUserId', newId);
            return 'ATG' + newId.toString().padStart(4, '0');
        }

        // Función para validar número de teléfono
        function isValidPhone(phone) {
            if (!phone) return false;
            // Eliminar espacios, guiones y paréntesis
            const cleaned = phone.replace(/\D/g, '');
            // Validar que tenga 10 dígitos y empiece con 3
            return cleaned.length === 10 && cleaned.startsWith('3');
        }

        // Función para limpiar número de teléfono
        function cleanPhone(phone) {
            if (!phone) return '';
            return phone.replace(/\D/g, '');
        }

        // Función para formatear números de teléfono
        function formatPhone(phone) {
            if (!phone) return '';

            // Convertir a string y eliminar caracteres no numéricos
            const phoneStr = String(phone).replace(/\D/g, '');

            // Si tiene 10 dígitos, formatear como número colombiano
            if (phoneStr.length === 10) {
                return phoneStr;
            }

            // Devolver el valor original si no cumple con el formato
            return phoneStr;
        }

        // Función mejorada para convertir fechas al formato correcto
        function convertToISODate(dateValue) {
            if (!dateValue) return null;

            // Si es un número (serial de Excel), convertirlo a fecha
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                return date.toISOString().split('T')[0];
            }

            // Si ya es una fecha en formato ISO (YYYY-MM-DD)
            if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                return dateValue;
            }

            // Si es una fecha en formato local (DD/MM/YYYY)
            if (typeof dateValue === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateValue)) {
                const parts = dateValue.split('/');
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }

            // Si es un objeto Date
            if (dateValue instanceof Date) {
                return dateValue.toISOString().split('T')[0];
            }

            // Si no se puede parsear, devolver null
            return null;
        }

        // Validar formato de teléfono en tiempo real
        function setupPhoneValidation() {
            const phoneInputs = [
                { id: 'phone', errorId: 'phoneError' },
                { id: 'emergencyPhone', errorId: 'emergencyPhoneError' },
                { id: 'editPhone', errorId: 'editPhoneError' },
                { id: 'editEmergencyPhone', errorId: 'editEmergencyPhoneError' },
                { id: 'clientPhone', errorId: 'clientPhoneError' },
                { id: 'whatsappNumber', errorId: 'whatsappPhoneError' }
            ];

            phoneInputs.forEach(({ id, errorId }) => {
                const input = document.getElementById(id);
                const error = document.getElementById(errorId);

                if (input && error) {
                    input.addEventListener('input', function () {
                        if (this.value && !isValidPhone(this.value)) {
                            error.style.display = 'block';
                            this.classList.add('validation-error');
                        } else {
                            error.style.display = 'none';
                            this.classList.remove('validation-error');
                        }
                    });

                    input.addEventListener('blur', function () {
                        if (this.value && !isValidPhone(this.value)) {
                            error.style.display = 'block';
                            this.classList.add('validation-error');
                        }
                    });
                }
            });
        }

        // Enviar mensaje por WhatsApp
        function sendWhatsApp(userId, amount, endDate) {
            const user = users.find(u => u.id == userId);
            if (!user) return;

            // Validar teléfono
            if (!isValidPhone(user.phone)) {
                alert('El usuario no tiene un número de teléfono válido. Por favor, edite el usuario y agregue un número válido de 10 dígitos que comience con 3.');
                return;
            }

            // Rellenar el formulario de WhatsApp
            whatsappNumber.value = cleanPhone(user.phone);

            // Crear mensaje predeterminado
            const message = `Hola ${user.name}, tu pago en Antologia Box23 por un valor de $${amount} ha sido registrado. Tu membresía es válida hasta el ${endDate}. ¡Gracias por tu preferencia!`;
            whatsappMessage.value = message;
            messagePreview.textContent = message;

            // Actualizar enlace de WhatsApp
            updateWhatsAppLink();

            // Mostrar modal
            const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
            whatsappModal.show();
        }

        // Actualizar enlace de WhatsApp
        function updateWhatsAppLink() {
            const phone = cleanPhone(whatsappNumber.value);
            const message = whatsappMessage.value;

            if (phone && message) {
                const encodedMessage = encodeURIComponent(message);
                whatsappLink.href = `https://wa.me/57${phone}?text=${encodedMessage}`;
            }
        }

        // Filtrar usuarios en la tabla
        function filterUsers() {
            const searchText = searchUserInput.value.toLowerCase();
            const userRows = document.querySelectorAll('#usersList tr');

            userRows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const document = row.cells[2].textContent.toLowerCase();
                const phone = row.cells[3].textContent.toLowerCase();

                if (name.includes(searchText) || document.includes(searchText) || phone.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // NUEVA: Función para filtrar usuarios en la lista de asistencia
        function filterAttendanceUsers() {
            const searchText = document.getElementById('attendanceSearchInput').value.toLowerCase();
            const userItems = document.querySelectorAll('.attendance-user-item');

            userItems.forEach(item => {
                const userName = item.querySelector('.attendance-user-name').textContent.toLowerCase();
                if (userName.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Formatear fecha a formato legible
        function formatDate(dateString) {
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('es-ES', options);
        }

        // Verificar si existe un archivo de respaldo automático
        function checkAutoBackup() {
            // Verificar si hay datos en localStorage primero
            if (users.length === 0 && attendance.length === 0 && income.length === 0) {
                // Buscar archivo de respaldo automático
                const backupKey = 'gymSystemBackup';
                const autoBackup = localStorage.getItem(backupKey);

                if (autoBackup) {
                    try {
                        const backupData = JSON.parse(autoBackup);

                        // Verificar que backupData tenga la estructura esperada
                        if (backupData.users && backupData.attendance && backupData.income) {
                            // Mostrar sección de restauración automática
                            autorestoreSection.classList.remove('d-none');
                        }
                    } catch (e) {
                        console.error('Error al analizar el respaldo automático:', e);
                    }
                }
            }
        }

        // Iniciar respaldo automático
        function startAutoBackup() {
            if (autoBackupInterval) {
                clearInterval(autoBackupInterval);
            }

            autoBackupInterval = setInterval(function () {
                createAutoBackup();
                showBackupNotification('Respaldo automático realizado cada 15 minutos');
            }, 15 * 60 * 1000); // 15 minutos
        }

        // Detener respaldo automático
        function stopAutoBackup() {
            if (autoBackupInterval) {
                clearInterval(autoBackupInterval);
                autoBackupInterval = null;
            }
        }

        // Mostrar notificación de respaldo
        function showBackupNotification(message) {
            backupNotificationText.textContent = message;
            backupNotification.style.display = 'block';

            setTimeout(function () {
                backupNotification.style.display = 'none';
            }, 5000);
        }

        // Crear respaldo automático periódico
        // Crear respaldo automático periódico
        function createAutoBackup() {
            const backupKey = 'gymSystemBackup';
            const backupData = {
                users: users,
                attendance: attendance,
                income: income,
                timestamp: new Date().toISOString(),
                totalRecords: {
                    users: users.length,
                    attendance: attendance.length,
                    income: income.length
                }
            };

            // Guardar en localStorage
            localStorage.setItem(backupKey, JSON.stringify(backupData));
            lastBackup = new Date().toLocaleString();
            localStorage.setItem('lastBackup', lastBackup);
            updateSystemInfo();

            // ✅ NUEVO: También respaldar en Neon
            setTimeout(() => {
                backupToNeon(backupData).then(result => {
                    if (result) {
                        console.log('Respaldo automático en nube completado');
                    }
                });
            }, 1000);
        }
        // Actualizar vista previa del formulario de WhatsApp
        function updateWhatsAppFormPreview() {
            const name = document.getElementById('clientName').value || '[Nombre del cliente]';
            const phone = document.getElementById('clientPhone').value || '[Teléfono]';
            const groupLink = document.getElementById('whatsappGroupLink').value;
            const includeGroupLink = document.getElementById('includeGroupLink').checked;
            const includeGoogleForm = document.getElementById('includeGoogleForm').checked;

            let message = `Hola ${name}, bienvenido/a a Antología Box23. Para completar tu registro, necesitamos los siguientes datos:
            
1. Nombre completo:
2. Número de documento:
3. Fecha de nacimiento:
4. Tipo de sangre (RH):
5. EPS:
6. Alguna patología o condición médica que debamos conocer:
7. Teléfono de contacto de emergencia:
8. Nombre del contacto de emergencia:

¡Gracias por colaborar!`;

            if (includeGroupLink && groupLink) {
                message += `\n\nÚnete a nuestro grupo de WhatsApp: ${groupLink}`;
            }

            if (includeGoogleForm) {
                message += `\n\nO completa nuestro formulario en línea: https://forms.gle/ZHUj1Q7YiDhE5P498`;
            }

            document.getElementById('whatsappFormPreview').textContent = message;

            // Actualizar enlace de WhatsApp
            const encodedMessage = encodeURIComponent(message);
            const cleanedPhone = cleanPhone(phone);
            document.getElementById('whatsappFormLink').href = `https://wa.me/57${cleanedPhone}?text=${encodedMessage}`;
        }

        // MEJORADA: Cargar usuarios en las listas desplegables con búsqueda
        function loadUserSelects() {
            const userSelect = document.getElementById('incomeUserSelect');
            const incomeFilterUser = document.getElementById('incomeFilterUser');
            const attendanceUserFilter = document.getElementById('attendanceUserFilter');

            // Limpiar selects
            userSelect.innerHTML = '<option value="">Seleccionar usuario</option>';
            incomeFilterUser.innerHTML = '<option value="">Todos los usuarios</option>';
            attendanceUserFilter.innerHTML = '<option value="">Todos los usuarios</option>';

            // Llenar con usuarios activos
            users.forEach(user => {
                if (user.status !== 'inactive') {
                    // Para el select de pagos (con información completa)
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} - ${user.classTime} - ${user.document || 'Sin documento'}`;
                    userSelect.appendChild(option);

                    // Para filtros (solo nombre)
                    const filterOption = document.createElement('option');
                    filterOption.value = user.id;
                    filterOption.textContent = user.name;
                    incomeFilterUser.appendChild(filterOption);

                    const attendanceFilterOption = document.createElement('option');
                    attendanceFilterOption.value = user.id;
                    attendanceFilterOption.textContent = user.name;
                    attendanceUserFilter.appendChild(attendanceFilterOption);
                }
            });

            // Configurar búsqueda en tiempo real para el select de pagos
            setupUserSearch();
        }

        // NUEVA: Función para configurar búsqueda en tiempo real en pagos
        function setupUserSearch() {
            // Verificar si ya existe el campo de búsqueda
            let searchInput = document.getElementById('incomeUserSearch');

            if (!searchInput) {
                // Crear el campo de búsqueda si no existe
                const incomeForm = document.getElementById('incomeForm');
                const userSelectContainer = incomeForm.querySelector('#incomeUserSelect').parentNode;

                const searchContainer = document.createElement('div');
                searchContainer.className = 'mb-3';
                searchContainer.innerHTML = `
                    <label for="incomeUserSearch" class="form-label">Buscar usuario</label>
                    <input type="text" class="form-control" id="incomeUserSearch" placeholder="Escriba nombre, documento o clase...">
                `;

                incomeForm.insertBefore(searchContainer, userSelectContainer);

                // Actualizar referencia
                searchInput = document.getElementById('incomeUserSearch');
            }

            // Agregar evento de búsqueda
            searchInput.addEventListener('input', function () {
                const searchText = this.value.toLowerCase();
                const userSelect = document.getElementById('incomeUserSelect');
                const options = userSelect.options;

                // Mostrar/ocultar opciones según la búsqueda
                for (let i = 0; i < options.length; i++) {
                    const option = options[i];
                    if (option.textContent.toLowerCase().includes(searchText)) {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                }

                // Si solo hay una opción visible, seleccionarla automáticamente
                const visibleOptions = Array.from(options).filter(opt => opt.style.display !== 'none');
                if (visibleOptions.length === 1 && visibleOptions[0].value) {
                    userSelect.value = visibleOptions[0].value;
                }
            });
        }

        // Cargar lista de usuarios
        function loadUsers() {
            usersList.innerHTML = '';
            users.forEach(user => {
                const statusBadge = user.status === 'active'
                    ? '<span class="badge bg-success user-status-badge">Activo</span>'
                    : '<span class="badge bg-danger user-status-badge">Inactivo</span>';

                // Verificar si el usuario tiene cumpleaños próximos (7 días)
                const birthdayInfo = getUpcomingBirthdayInfo(user.birthdate);
                const birthdayBadge = birthdayInfo ? `<span class="birthday-badge">🎂 ${birthdayInfo.daysUntil} días</span>` : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name} ${birthdayBadge}</td>
                    <td>${user.document || '-'}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${user.classTime || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-warning me-1" onclick="showEmergencyInfo('${user.id}')">
                            <i class="fas fa-first-aid"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                usersList.appendChild(row);
            });

            loadUserSelects();
            updateSystemInfo();

            // Crear respaldo automático después de cargar usuarios
            createAutoBackup();

            // Verificar cumpleaños próximos al cargar usuarios
            checkUpcomingBirthdays();
        }

        // Mostrar información de emergencia
        function showEmergencyInfo(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const emergencyInfoContent = document.getElementById('emergencyInfoContent');
            emergencyInfoContent.innerHTML = `
                <h6>Información de ${user.name}</h6>
                <div class="emergency-info">
                    <p><strong>EPS:</strong> ${user.eps || 'No registrada'}</p>
                    <p><strong>Tipo de sangre (RH):</strong> ${user.rh || 'No registrado'}</p>
                    <p><strong>Patologías:</strong> ${user.pathology || 'Ninguna registrada'}</p>
                    <p><strong>Contacto de emergencia:</strong> ${user.emergencyContact || 'No registrado'}</p>
                    <p><strong>Teléfono de emergencia:</strong> ${user.emergencyPhone || 'No registrado'}</p>
                </div>
            `;

            const emergencyModal = new bootstrap.Modal(document.getElementById('emergencyInfoModal'));
            emergencyModal.show();
        }

        // Editar usuario
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // Llenar el formulario de edición
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editName').value = user.name;
            document.getElementById('editDocument').value = user.document || '';

            // Manejar fecha de nacimiento
            document.getElementById('editBirthdate').value = user.birthdate || '';

            // Manejar teléfono
            document.getElementById('editPhone').value = user.phone || '';

            document.getElementById('editEps').value = user.eps || '';
            document.getElementById('editRh').value = user.rh || '';
            document.getElementById('editPathology').value = user.pathology || '';
            document.getElementById('editEmergencyContact').value = user.emergencyContact || '';

            // Manejar teléfono de emergencia
            document.getElementById('editEmergencyPhone').value = user.emergencyPhone || '';

            document.getElementById('editClassTime').value = user.classTime || '';
            document.getElementById('editAffiliationType').value = user.affiliationType || '';
            document.getElementById('editStatus').value = user.status || 'active';

            // Mostrar el modal
            const editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
            editUserModal.show();
        }

        // Guardar usuario editado
        document.getElementById('saveEditUser').addEventListener('click', function () {
            const userId = document.getElementById('editUserId').value;
            const userIndex = users.findIndex(u => u.id === userId);

            if (userIndex === -1) return;

            // Validar teléfonos
            const phone = document.getElementById('editPhone').value;
            const emergencyPhone = document.getElementById('editEmergencyPhone').value;

            if (phone && !isValidPhone(phone)) {
                alert('El formato del teléfono principal es inválido. Debe tener 10 dígitos y comenzar con 3.');
                return;
            }

            if (emergencyPhone && !isValidPhone(emergencyPhone)) {
                alert('El formato del teléfono de emergencia es inválido. Debe tener 10 dígitos y comenzar con 3.');
                return;
            }

            // Actualizar datos del usuario
            users[userIndex] = {
                ...users[userIndex],
                name: document.getElementById('editName').value,
                document: document.getElementById('editDocument').value,
                birthdate: document.getElementById('editBirthdate').value,
                phone: document.getElementById('editPhone').value,
                eps: document.getElementById('editEps').value,
                rh: document.getElementById('editRh').value,
                pathology: document.getElementById('editPathology').value,
                emergencyContact: document.getElementById('editEmergencyContact').value,
                emergencyPhone: document.getElementById('editEmergencyPhone').value,
                classTime: document.getElementById('editClassTime').value,
                affiliationType: document.getElementById('editAffiliationType').value,
                status: document.getElementById('editStatus').value
            };

            // Guardar en localStorage
            saveToLocalStorage();

            // Recargar la lista
            loadUsers();

            // Cerrar el modal
            const editUserModal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            editUserModal.hide();

            alert('Usuario actualizado correctamente!');
        });

        // Función para obtener el último pago de un usuario
        function getLastPayment(userId) {
            const userPayments = income.filter(payment => payment.userId == userId);
            if (userPayments.length === 0) return null;

            // Ordenar por endDate descendente
            userPayments.sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
            return userPayments[0];
        }

        // Cargar asistencias - NUEVA VERSIÓN MEJORADA (lista única ordenada alfabéticamente)
        function loadAttendanceByClass() {
            const attendanceDate = document.getElementById('attendanceDate').value;
            const attendanceUsersList = document.getElementById('attendanceUsersList');
            attendanceUsersList.innerHTML = '';

            let totalUsers = 0;
            let presentUsers = 0;

            // Obtener usuarios activos (excepto entrenadores) y ordenarlos alfabéticamente
            const activeUsers = users
                .filter(user => user.status === 'active' && user.affiliationType !== 'Entrenador(a)')
                .sort((a, b) => a.name.localeCompare(b.name));

            totalUsers = activeUsers.length;

            activeUsers.forEach(user => {
                const isPresent = attendance.some(a =>
                    a.userId === user.id &&
                    a.date === attendanceDate &&
                    a.status === 'presente'
                );

                if (isPresent) presentUsers++;

                // Verificar si la membresía está vencida
                const membershipStatus = checkMembershipStatus(user.id);
                
                // Obtener el último pago del usuario
                const lastPayment = getLastPayment(user.id);

                const userItem = document.createElement('div');
                userItem.className = 'attendance-user-item';
                userItem.innerHTML = `
                    <div class="attendance-check-container">
                        <input class="form-check-input attendance-checkbox" type="checkbox" 
                            id="attendance-${user.id}" 
                            data-user-id="${user.id}"
                            ${isPresent ? 'checked' : ''}>
                    </div>
                    <div class="attendance-user-info">
                        <div class="attendance-user-name">${user.name}</div>
                        <div class="attendance-user-details">
                            ${lastPayment ? `Vigencia: ${formatDate(lastPayment.startDate)} - ${formatDate(lastPayment.endDate)}` : 'Sin pago registrado'}
                            ${membershipStatus.expired ? ` | <span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Vencida hace ${membershipStatus.daysExpired} días</span>` : ''}
                        </div>
                    </div>
                    <div class="attendance-actions">
                        <button class="btn btn-sm btn-outline-info" onclick="showEmergencyInfo('${user.id}')">
                            <i class="fas fa-first-aid"></i>
                        </button>
                    </div>
                `;

                attendanceUsersList.appendChild(userItem);
            });

            // Actualizar estadísticas
            totalUsersCount.textContent = totalUsers;
            presentUsersCount.textContent = presentUsers;
            pendingUsersCount.textContent = totalUsers - presentUsers;

            // Agregar event listeners a los checkboxes
            document.querySelectorAll('.attendance-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateAttendanceStats);
            });

            // Verificar inasistencias consecutivas
            checkConsecutiveAbsences();

            // Crear respaldo automático después de cargar asistencias
            createAutoBackup();
        }

        // Actualizar estadísticas de asistencia
        function updateAttendanceStats() {
            const totalCheckboxes = document.querySelectorAll('.attendance-checkbox').length;
            const presentCheckboxes = document.querySelectorAll('.attendance-checkbox:checked').length;

            presentUsersCount.textContent = presentCheckboxes;
            pendingUsersCount.textContent = totalCheckboxes - presentCheckboxes;
        }

        // Verificar estado de la membresía
        function checkMembershipStatus(userId) {
            const userIncome = income.filter(i => i.userId === userId);
            if (userIncome.length === 0) {
                return { expired: true, daysExpired: 'N/A' };
            }

            // Obtener el último pago
            const lastPayment = userIncome.sort((a, b) => new Date(b.endDate) - new Date(a.endDate))[0];
            const today = new Date();
            const endDate = new Date(lastPayment.endDate);

            if (today > endDate) {
                // Calcular días de vencimiento
                const diffTime = Math.abs(today - endDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return { expired: true, daysExpired: diffDays };
            }

            return { expired: false, daysExpired: 0 };
        }

        // Función para verificar inasistencias consecutivas
        function checkConsecutiveAbsences() {
            absenceAlertsList.innerHTML = '';

            const activeUsers = users.filter(user =>
                user.status === 'active' && user.affiliationType !== 'Entrenador(a)'
            );

            let hasAlerts = false;

            activeUsers.forEach(user => {
                const userAttendance = attendance
                    .filter(a => a.userId === user.id && a.status === 'presente')
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                // Obtener las últimas 5 fechas de asistencia registradas (no necesariamente consecutivas)
                const lastAttendanceDates = userAttendance.slice(0, 5).map(a => a.date);

                // Encontrar la última fecha de asistencia
                const lastAttendanceDate = lastAttendanceDates.length > 0 ?
                    new Date(lastAttendanceDates[0]) : null;

                if (lastAttendanceDate) {
                    // Calcular días desde la última asistencia
                    const today = new Date();
                    const diffTime = Math.abs(today - lastAttendanceDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    // Si han pasado más de 7 días desde la última asistencia, mostrar alerta
                    if (diffDays > 7) {
                        hasAlerts = true;

                        const alertItem = document.createElement('div');
                        alertItem.className = 'absence-alert-item';
                        alertItem.innerHTML = `
                            <div class="absence-alert-header">
                                <div>
                                    <strong>${user.name}</strong> - No asiste desde hace ${diffDays} días
                                    <br>
                                    <small>Última asistencia: ${formatDate(lastAttendanceDate.toISOString().split('T')[0])}</small>
                                </div>
                                <div class="absence-alert-actions">
                                    <button class="btn btn-sm btn-success me-1" onclick="sendReminderWhatsApp('${user.id}')">
                                        <i class="fab fa-whatsapp"></i> Recordatorio
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="inactivateUser('${user.id}')">
                                        <i class="fas fa-user-slash"></i> Inactivar
                                    </button>
                                </div>
                            </div>
                        `;
                        absenceAlertsList.appendChild(alertItem);
                    }
                }
            });

            if (!hasAlerts) {
                absenceAlertsList.innerHTML = '<p class="text-muted">No hay alertas de inasistencias en este momento.</p>';
            }
        }

        // Función para enviar recordatorio por WhatsApp
        function sendReminderWhatsApp(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // Validar teléfono
            if (!isValidPhone(user.phone)) {
                alert('El usuario no tiene un número de teléfono válido. Por favor, edite el usuario y agregue un número válido.');
                return;
            }

            // Rellenar el formulario de WhatsApp
            whatsappNumber.value = cleanPhone(user.phone);

            // Crear mensaje de recordatorio personalizado
            const lastAttendance = attendance
                .filter(a => a.userId === userId && a.status === 'presente')
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

            const lastAttendanceDate = lastAttendance ? formatDate(lastAttendance.date) : 'No registrada';

            const message = `Hola ${user.name}, ¡te extrañamos en Antología Box23! 👋

Hemos notado que no hemos tenido el gusto de verte desde el ${lastAttendanceDate}. 

¿Todo bien? Esperamos que puedas regresar pronto a tus entrenamientos. Si hay algún inconveniente o necesitas ayuda, no dudes en contarnos.

¡Quedamos atentos a cualquier inquietud!

💪 El equipo de Antología Box23`;

            whatsappMessage.value = message;
            messagePreview.textContent = message;

            // Actualizar enlace de WhatsApp
            updateWhatsAppLink();

            // Mostrar modal
            const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
            whatsappModal.show();
        }

        // Función para inactivar usuario
        function inactivateUser(userId) {
            if (confirm('¿Está seguro de que desea inactivar este usuario? Esto cambiará su estado a inactivo.')) {
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].status = 'inactive';
                    saveToLocalStorage();
                    loadUsers();
                    checkConsecutiveAbsences(); // Recargar alertas
                    alert('Usuario inactivado correctamente.');
                }
            }
        }

        // Cargar lista de asistencias
        function loadAttendance() {
            attendanceList.innerHTML = '';
            const startDate = document.getElementById('attendanceStartDateFilter').value;
            const endDate = document.getElementById('attendanceEndDateFilter').value;
            const userId = document.getElementById('attendanceUserFilter').value;

            let filteredAttendance = attendance;

            // Filtrar por fecha
            if (startDate && endDate) {
                filteredAttendance = filteredAttendance.filter(a => a.date >= startDate && a.date <= endDate);
            }

            // Filtrar por usuario
            if (userId) {
                filteredAttendance = filteredAttendance.filter(a => a.userId == userId);
            }

            filteredAttendance.forEach(record => {
                const user = users.find(u => u.id == record.userId) || { name: 'Usuario eliminado', classTime: 'N/A' };
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${user.name}</td>
                    <td>${user.classTime}</td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(record.status)}">${record.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteAttendance(${record.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                attendanceList.appendChild(row);
            });

            updateSystemInfo();
        }

        // Obtener clase CSS para el badge de estado
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'presente': return 'bg-success';
                case 'ausente': return 'bg-danger';
                case 'tarde': return 'bg-warning';
                case 'permiso': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        // Eliminar registro de pago
        function deleteIncome(incomeId) {
            if (confirm('¿Está seguro de que desea eliminar este registro de pago?')) {
                income = income.filter(i => i.id !== incomeId);
                saveToLocalStorage();
                loadIncome();
                alert('Registro de pago eliminado correctamente.');
            }
        }

        // Eliminar registro de asistencia
        function deleteAttendance(attendanceId) {
            if (confirm('¿Está seguro de que desea eliminar este registro de asistencia?')) {
                attendance = attendance.filter(a => a.id !== attendanceId);
                saveToLocalStorage();
                loadAttendance();
                alert('Registro de asistencia eliminado correctamente.');
            }
        }

        // Eliminar usuario
        function deleteUser(userId) {
            if (confirm('¿Está seguro de que desea eliminar este usuario?')) {
                users = users.filter(user => user.id !== userId);
                saveToLocalStorage();
                loadUsers();
            }
        }

        // Verificar finalización de paquetes
        function checkPackageCompletion() {
            const filterUser = document.getElementById('incomeFilterUser').value;

            if (!filterUser) {
                packageWarning.classList.add('d-none');
                return;
            }

            const user = users.find(u => u.id == filterUser);
            if (!user || user.affiliationType !== 'paquete 10 clases') {
                packageWarning.classList.add('d-none');
                return;
            }

            // Contar asistencias desde el último pago
            const lastPayment = income
                .filter(i => i.userId == filterUser)
                .sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate))[0];

            if (!lastPayment) {
                packageWarning.classList.add('d-none');
                return;
            }

            const attendanceCount = attendance.filter(a =>
                a.userId == filterUser &&
                a.date >= lastPayment.paymentDate &&
                a.status === 'presente'
            ).length;

            if (attendanceCount >= 10) {
                warningText.textContent = `¡Atención! Este usuario ha completado las 10 clases del paquete.`;
                packageWarning.classList.remove('d-none');
            } else {
                packageWarning.classList.add('d-none');
            }
        }

        // Cargar lista de pagos
        function loadIncome() {
            incomeList.innerHTML = '';
            const startDate = document.getElementById('incomeStartDateFilter').value;
            const endDate = document.getElementById('incomeEndDateFilter').value;
            const userId = document.getElementById('incomeFilterUser').value;

            let filteredIncome = income;
            let total = 0;

            // Filtrar por fecha
            if (startDate && endDate) {
                filteredIncome = filteredIncome.filter(i => i.paymentDate >= startDate && i.paymentDate <= endDate);
            }

            // Filtrar por usuario
            if (userId) {
                filteredIncome = filteredIncome.filter(i => i.userId == userId);
            }

            filteredIncome.forEach(record => {
                const user = users.find(u => u.id == record.userId) || { name: 'Usuario eliminado' };
                const amount = parseFloat(record.amount);
                total += amount;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.paymentDate}</td>
                    <td>${user.name}</td>
                    <td>$${amount.toFixed(2)}</td>
                    <td>${record.paymentMethod}</td>
                    <td>${record.endDate}</td>
                    <td>${record.description || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteIncome(${record.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                incomeList.appendChild(row);
            });

            // Actualizar total
            document.getElementById('incomeTotal').textContent = `$${total.toFixed(2)}`;

            updateSystemInfo();
            checkPackageCompletion();

            // Crear respaldo automático después de cargar pagos
            createAutoBackup();
        }

        // Cargar reportes
        function loadReports() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const reportType = document.getElementById('reportType').value;

            // Actualizar estadísticas generales
            const activeUsers = users.filter(u => u.status === 'active').length;
            document.getElementById('reportTotalUsers').textContent = activeUsers;

            // Calcular ingresos del mes actual
            const currentDate = new Date();
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).toISOString().split('T')[0];

            const monthlyIncome = income
                .filter(i => i.paymentDate >= firstDay && i.paymentDate <= lastDay)
                .reduce((sum, record) => sum + parseFloat(record.amount), 0);

            document.getElementById('reportTotalIncome').textContent = `$${monthlyIncome.toFixed(2)}`;

            // Calcular tasa de asistencia
            const totalAttendance = attendance.filter(a => a.status === 'presente').length;
            const possibleAttendance = activeUsers * 20; // Estimación de 20 días por mes
            const attendanceRate = possibleAttendance > 0 ? Math.round((totalAttendance / possibleAttendance) * 100) : 0;
            document.getElementById('reportAttendanceRate').textContent = `${attendanceRate}%`;

            // Calcular paquetes completados
            const packagesCompleted = users.filter(u => u.affiliationType === 'paquete 10 clases').length;
            document.getElementById('reportPackagesCompleted').textContent = packagesCompleted;

            // Cargar datos del reporte según el tipo seleccionado
            const reportList = document.getElementById('reportList');
            reportList.innerHTML = '';

            if (reportType === 'attendance') {
                // Reporte de asistencias
                let filteredAttendance = attendance;

                if (startDate && endDate) {
                    filteredAttendance = filteredAttendance.filter(a => a.date >= startDate && a.date <= endDate);
                }

                filteredAttendance.forEach(record => {
                    const user = users.find(u => u.id == record.userId) || { name: 'Usuario eliminado' };
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>Asistencia registrada</td>
                        <td>${user.name}</td>
                        <td><span class="badge bg-success">${record.status}</span></td>
                        <td>Clase: ${user.classTime || 'N/A'}</td>
                    `;
                    reportList.appendChild(row);
                });
            } else if (reportType === 'income') {
                // Reporte de pagos
                let filteredIncome = income;

                if (startDate && endDate) {
                    filteredIncome = filteredIncome.filter(i => i.paymentDate >= startDate && i.paymentDate <= endDate);
                }

                filteredIncome.forEach(record => {
                    const user = users.find(u => u.id == record.userId) || { name: 'Usuario eliminado' };
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.paymentDate}</td>
                        <td>Pago registrado - ${record.description || 'Sin descripción'}</td>
                        <td>${user.name}</td>
                        <td>$${parseFloat(record.amount).toFixed(2)}</td>
                        <td>Método: ${record.paymentMethod}, Válido hasta: ${record.endDate}</td>
                    `;
                    reportList.appendChild(row);
                });
            } else {
                // Reporte de usuarios
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                        <td>Usuario registrado</td>
                        <td>${user.name}</td>
                        <td>${user.affiliationType}</td>
                        <td>Documento: ${user.document}, Tel: ${user.phone}</td>
                    `;
                    reportList.appendChild(row);
                });
            }

            // Actualizar gráficos
            updateCharts();
        }

        // Actualizar gráficos
        function updateCharts() {
            // Destruir gráficos existentes si los hay
            if (affiliationChart) {
                affiliationChart.destroy();
            }
            if (attendanceChart) {
                attendanceChart.destroy();
            }

            // Gráfico de distribución por tipo de afiliación
            const affiliationCtx = document.getElementById('affiliationChart').getContext('2d');
            const affiliationTypes = {};

            users.forEach(user => {
                const type = user.affiliationType || 'Sin especificar';
                affiliationTypes[type] = (affiliationTypes[type] || 0) + 1;
            });

            affiliationChart = new Chart(affiliationCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(affiliationTypes),
                    datasets: [{
                        data: Object.values(affiliationTypes),
                        backgroundColor: [
                            '#27F9D4', '#FF729F', '#7C77B9', '#1D8A99', '#F0F66E',
                            '#5C80BC', '#F7934C', '#4C5B5C', '#FF9F1C', '#A4036F'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#f8f9fa',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de asistencia por clase
            const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
            const classAttendance = {};

            classTimes.forEach(classTime => {
                classAttendance[classTime] = attendance.filter(a => {
                    const user = users.find(u => u.id == a.userId);
                    return user && user.classTime === classTime && a.status === 'presente';
                }).length;
            });

            attendanceChart = new Chart(attendanceCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(classAttendance),
                    datasets: [{
                        label: 'Asistencias',
                        data: Object.values(classAttendance),
                        backgroundColor: '#27F9D4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#f8f9fa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#f8f9fa',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Actualizar información del sistema
        function updateSystemInfo() {
            document.getElementById('infoUsers').textContent = users.length;
            document.getElementById('infoAttendance').textContent = attendance.length;
            document.getElementById('infoIncome').textContent = income.length;
            document.getElementById('infoLastBackup').textContent = lastBackup;
        }

        // Preprocesar datos de importación
        function preprocessImportData(workbook) {
            // Reiniciar datos de importación
            importData = {
                users: [],
                attendance: [],
                income: [],
                summary: {
                    users: { success: 0, warnings: 0, errors: 0 },
                    attendance: { success: 0, warnings: 0, errors: 0 },
                    income: { success: 0, warnings: 0, errors: 0 }
                }
            };

            // Leer datos de usuarios
            const usersSheet = workbook.Sheets['Usuarios'];
            let usersData = XLSX.utils.sheet_to_json(usersSheet);

            // Procesar datos de usuarios
            usersData.forEach((user, index) => {
                const processedUser = {
                    id: user.ID || user.id || generateNextUserId(),
                    name: user.Nombre || user.name || '',
                    document: String(user.Documento || user.document || ''),
                    birthdate: convertToISODate(user['Fecha Nacimiento'] || user.birthdate),
                    phone: formatPhone(user.Telefono || user.phone),
                    eps: user.EPS || user.eps || '',
                    rh: user.RH || user.rh || '',
                    pathology: user.Patologia || user.pathology || '',
                    emergencyContact: user['Contacto Emergencia'] || user.emergencyContact || '',
                    emergencyPhone: formatPhone(user['Telefono Emergencia'] || user.emergencyPhone),
                    classTime: user.Clase || user.classTime || '',
                    affiliationType: user['Tipo Afiliacion'] || user.affiliationType || '',
                    status: user.Estado || user.status || 'active',
                    createdAt: user['Fecha Registro'] || user.createdAt || new Date().toISOString()
                };

                // Validar campos obligatorios
                if (!processedUser.name) {
                    importData.summary.users.errors++;
                    return;
                }

                // Validar teléfono
                if (processedUser.phone && !isValidPhone(processedUser.phone)) {
                    importData.summary.users.warnings++;
                } else {
                    importData.summary.users.success++;
                }

                importData.users.push(processedUser);
            });

            // Leer datos de asistencias
            const attendanceSheet = workbook.Sheets['Asistencias'];
            let attendanceData = XLSX.utils.sheet_to_json(attendanceSheet);

            // Procesar datos de asistencias
            attendanceData.forEach(record => {
                const processedAttendance = {
                    id: record.ID || record.id || Date.now(),
                    userId: record.UsuarioID || record.userId,
                    date: convertToISODate(record.Fecha || record.date),
                    status: record.Estado || record.status || 'presente',
                    registeredAt: record['Fecha Registro'] || record.registeredAt || new Date().toISOString()
                };

                // Validar campos obligatorios
                if (!processedAttendance.userId || !processedAttendance.date) {
                    importData.summary.attendance.errors++;
                    return;
                }

                importData.summary.attendance.success++;
                importData.attendance.push(processedAttendance);
            });

            // Leer datos de pagos
            const incomeSheet = workbook.Sheets['Pagos'];
            let incomeData = XLSX.utils.sheet_to_json(incomeSheet);

            // Procesar datos de pagos
            incomeData.forEach(record => {
                const processedIncome = {
                    id: record.ID || record.id || Date.now(),
                    userId: record.UsuarioID || record.userId,
                    paymentDate: convertToISODate(record['Fecha Pago'] || record.paymentDate),
                    startDate: convertToISODate(record['Fecha Inicio'] || record.startDate),
                    endDate: convertToISODate(record['Fecha Fin'] || record.endDate),
                    paymentMethod: record['Método Pago'] || record.paymentMethod || 'efectivo',
                    amount: parseFloat(record.Monto || record.amount || 0),
                    description: record.Descripción || record.description || '',
                    registeredAt: record['Fecha Registro'] || record.registeredAt || new Date().toISOString()
                };

                // Validar campos obligatorios
                if (!processedIncome.userId || !processedIncome.paymentDate) {
                    importData.summary.income.errors++;
                    return;
                }

                importData.summary.income.success++;
                importData.income.push(processedIncome);
            });

            // Mostrar resumen de importación
            showImportSummary();
        }

        // Mostrar resumen de importación
        function showImportSummary() {
            let summaryHTML = `
                <div class="alert alert-info">
                    <h6>Resumen de importación</h6>
                    <p>Se han detectado los siguientes datos en el archivo:</p>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">${importData.users.length}</h5>
                                <p class="card-text">Usuarios</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">${importData.attendance.length}</h5>
                                <p class="card-text">Asistencias</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">${importData.income.length}</h5>
                                <p class="card-text">Pagos</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="import-summary">
                    <h6>Detalles de importación:</h6>
            `;

            // Resumen de usuarios
            summaryHTML += `
                <div class="import-summary-item">
                    <strong>Usuarios:</strong>
                    <span class="import-success">✓ ${importData.summary.users.success} válidos</span>,
                    <span class="import-warning">⚠ ${importData.summary.users.warnings} con advertencias</span>,
                    <span class="import-error">✗ ${importData.summary.users.errors} con errores</span>
                </div>
            `;

            // Resumen de asistencias
            summaryHTML += `
                <div class="import-summary-item">
                    <strong>Asistencias:</strong>
                    <span class="import-success">✓ ${importData.summary.attendance.success} válidas</span>,
                    <span class="import-error">✗ ${importData.summary.attendance.errors} con errores</span>
                </div>
            `;

            // Resumen de pagos
            summaryHTML += `
                <div class="import-summary-item">
                    <strong>Pagos:</strong>
                    <span class="import-success">✓ ${importData.summary.income.success} válidos</span>,
                    <span class="import-error">✗ ${importData.summary.income.errors} con errores</span>
                </div>
            `;

            summaryHTML += `</div>`;

            importSummaryContent.innerHTML = summaryHTML;

            // Mostrar modal de resumen
            const importModal = new bootstrap.Modal(document.getElementById('importSummaryModal'));
            importModal.show();
        }

        // Confirmar importación de datos
        function confirmImport() {
            const replaceData = replaceDataCheckbox.checked;

            if (replaceData) {
                // Reemplazar todos los datos
                users = importData.users;
                attendance = importData.attendance;
                income = importData.income;
            } else {
                // Fusionar datos (evitar duplicados)
                importData.users.forEach(newUser => {
                    const existingIndex = users.findIndex(u => u.id === newUser.id);
                    if (existingIndex === -1) {
                        users.push(newUser);
                    } else {
                        users[existingIndex] = newUser;
                    }
                });

                importData.attendance.forEach(newAttendance => {
                    const existingIndex = attendance.findIndex(a => a.id === newAttendance.id);
                    if (existingIndex === -1) {
                        attendance.push(newAttendance);
                    } else {
                        attendance[existingIndex] = newAttendance;
                    }
                });

                importData.income.forEach(newIncome => {
                    const existingIndex = income.findIndex(i => i.id === newIncome.id);
                    if (existingIndex === -1) {
                        income.push(newIncome);
                    } else {
                        income[existingIndex] = newIncome;
                    }
                });
            }

            // Guardar en localStorage
            saveToLocalStorage();

            // Recargar todas las secciones
            loadUsers();
            loadAttendanceByClass();
            loadAttendance();
            loadIncome();
            updateSystemInfo();
            loadReports();

            // Cerrar modal
            const importModal = bootstrap.Modal.getInstance(document.getElementById('importSummaryModal'));
            importModal.hide();

            // Mostrar mensaje de éxito
            alert('Datos importados correctamente!');
        }

        // CORREGIDA: Función para obtener información de cumpleaños próximos
        function getUpcomingBirthdayInfo(birthdate) {
            if (!birthdate) return null;

            const today = new Date();
            // Crear fecha de hoy sin hora (medianoche)
            const todayLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate());

            // Parsear la fecha de nacimiento
            const [year, month, day] = birthdate.split('-').map(Number);
            // Crear fecha de cumpleaños para este año
            const birthdayThisYear = new Date(today.getFullYear(), month - 1, day);

            // Si el cumpleaños ya pasó este año, usar el próximo año
            if (birthdayThisYear < todayLocal) {
                birthdayThisYear.setFullYear(today.getFullYear() + 1);
            }

            // Calcular días hasta el cumpleaños
            const diffTime = birthdayThisYear - todayLocal;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Si está en los próximos 7 días
            if (diffDays >= 0 && diffDays <= 7) {
                return { daysUntil: diffDays, date: birthdayThisYear };
            }

            return null;
        }

        // Función para obtener usuarios con cumpleaños próximos
        function getUpcomingBirthdays(days = 7) {
            const today = new Date();
            const upcomingBirthdays = [];

            users.forEach(user => {
                if (user.birthdate) {
                    const birthdayInfo = getUpcomingBirthdayInfo(user.birthdate);
                    if (birthdayInfo && birthdayInfo.daysUntil <= days) {
                        upcomingBirthdays.push({
                            user: user,
                            daysUntil: birthdayInfo.daysUntil,
                            date: birthdayInfo.date
                        });
                    }
                }
            });

            // Ordenar por días hasta el cumpleaños
            return upcomingBirthdays.sort((a, b) => a.daysUntil - b.daysUntil);
        }

        // CORREGIDA: Función para obtener usuarios con cumpleaños este mes
        function getBirthdaysThisMonth() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            const birthdaysThisMonth = [];

            users.forEach(user => {
                if (user.birthdate) {
                    const [year, month, day] = user.birthdate.split('-').map(Number);

                    // Verificar si el cumpleaños es este mes
                    if (month - 1 === currentMonth) {
                        // Crear fecha de cumpleaños para este año
                        const birthdayThisYear = new Date(currentYear, month - 1, day);

                        // Crear fecha de hoy sin hora (medianoche)
                        const todayWithoutTime = new Date(currentYear, today.getMonth(), today.getDate());

                        // Calcular días hasta el cumpleaños
                        const diffTime = birthdayThisYear - todayWithoutTime;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        birthdaysThisMonth.push({
                            user: user,
                            daysUntil: diffDays,
                            date: birthdayThisYear
                        });
                    }
                }
            });

            // Ordenar por fecha de cumpleaños (más cercano primero)
            return birthdaysThisMonth.sort((a, b) => a.daysUntil - b.daysUntil);
        }

        // CORREGIDA: Función para verificar cumpleaños próximos (próximos 7 días)
        function checkUpcomingBirthdays() {
            const upcomingBirthdays = getUpcomingBirthdays(7);

            if (upcomingBirthdays.length > 0) {
                // Mostrar modal automáticamente al cargar la aplicación
                showBirthdays('week');
            }
        }

        // CORREGIDA: Función para mostrar cumpleaños en un modal
        function showBirthdays(type) {
            let birthdays = [];
            let title = '';

            if (type === 'week') {
                birthdays = getUpcomingBirthdays(7);
                title = 'Cumpleaños en los próximos 7 días';
            } else {
                birthdays = getBirthdaysThisMonth();
                title = 'Cumpleaños del mes actual';
            }

            // Actualizar título del modal
            birthdayModalTitle.textContent = title;

            // Generar contenido
            let contentHTML = '';

            if (birthdays.length === 0) {
                contentHTML = '<p>No hay cumpleaños en el período seleccionado.</p>';
            } else {
                contentHTML = '<div class="list-group">';

                birthdays.forEach(birthday => {
                    const user = birthday.user;
                    const birthdayDate = birthday.date;

                    const formattedDate = birthdayDate.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    // Capitalizar primera letra del día de la semana
                    const capitalizedDate = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);

                    // Determinar el texto para "días hasta"
                    let daysText = '';
                    if (birthday.daysUntil === 0) {
                        daysText = '<span class="badge bg-success">¡Hoy!</span>';
                    } else if (birthday.daysUntil === 1) {
                        daysText = '<span class="badge bg-warning">Mañana</span>';
                    } else {
                        daysText = `<span class="badge bg-info">En ${birthday.daysUntil} días</span>`;
                    }

                    contentHTML += `
                        <div class="birthday-item">
                            <div class="birthday-user-info">
                                <div class="birthday-user-name">${user.name} ${daysText}</div>
                                <div class="birthday-user-details">
                                    ${user.classTime ? `Clase: ${user.classTime} | ` : ''}
                                    ${user.phone ? `Tel: ${user.phone}` : ''}
                                </div>
                            </div>
                            <div class="birthday-date">${capitalizedDate}</div>
                            <div class="birthday-actions">
                                <button class="btn btn-sm btn-outline-info" onclick="showEmergencyInfo('${user.id}')">
                                    <i class="fas fa-first-aid"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="sendBirthdayWhatsApp('${user.id}')">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });

                contentHTML += '</div>';
            }

            birthdayContent.innerHTML = contentHTML;

            // Mostrar modal
            const birthdayModal = new bootstrap.Modal(document.getElementById('birthdayModal'));
            birthdayModal.show();
        }

        // NUEVA: Función para enviar mensaje de cumpleaños por WhatsApp
        function sendBirthdayWhatsApp(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // Validar teléfono
            if (!isValidPhone(user.phone)) {
                alert('El usuario no tiene un número de teléfono válido. Por favor, edite el usuario y agregue un número válido.');
                return;
            }

            // Rellenar el formulario de WhatsApp
            whatsappNumber.value = cleanPhone(user.phone);

            // Crear mensaje de cumpleaños personalizado
            const message = `¡Feliz cumpleaños ${user.name}! 🎉🎂

En nombre de todo el equipo de Antología Box23, queremos desearte un día maravilloso lleno de alegría, salud y muchas bendiciones. 

Que este nuevo año de vida esté cargado de éxitos y momentos inolvidables.

¡Disfruta tu día especial! 🥳

Con cariño,
El equipo de Antología Box23`;

            whatsappMessage.value = message;
            messagePreview.textContent = message;

            // Actualizar enlace de WhatsApp
            updateWhatsAppLink();

            // Mostrar modal
            const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
            whatsappModal.show();
        }

        // Función para enviar felicitaciones de cumpleaños por WhatsApp
        function sendBirthdayWishes() {
            let message = `¡Feliz cumpleaños! 🎉🎂\n\nEn nombre de todo el equipo de Antología Box23, queremos desearte un día maravilloso lleno de alegría, salud y muchas bendiciones. Que este nuevo año de vida esté cargado de éxitos y momentos inolvidables.\n\n¡Disfruta tu día especial! 🥳`;

            // Rellenar el formulario de WhatsApp
            whatsappMessage.value = message;
            messagePreview.textContent = message;

            // Mostrar modal de WhatsApp
            const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
            whatsappModal.show();
        }

        // Inicializar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
            checkAutoBackup();

            // Verificar cumpleaños próximos al cargar la aplicación
            setTimeout(() => {
                checkUpcomingBirthdays();
            }, 1000);
        });
        // Manejo de rutas para SPA en GitHub Pages
        (function () {
            var redirect = sessionStorage.redirect;
            delete sessionStorage.redirect;
            if (redirect && redirect != location.href) {
                history.replaceState(null, null, redirect);
            }
        })();
    </script>
</body>

</html>


