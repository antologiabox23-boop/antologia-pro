ali<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antolog√≠a Box23 - Sistema de Gesti√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #27F9D4;
            --color-secondary: #FF729F;
            --color-background: #273043;
            --color-dark: #1a2332;
            --color-light: #f8f9fa;
            --color-table-header: #424b5f;
            --color-table-hover: #324466;
            --color-table: #3a4357;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-light);
        }

        .navbar,
        .card,
        .modal-content,
        .accordion-item,
        .input-group-text,
        .form-control,
        .form-select {
            background-color: var(--color-table);
            color: var(--color-light);
            border-color: var(--color-dark);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--color-table);
            color: var(--color-light);
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.25rem rgba(39, 249, 212, 0.25);
        }

        .table> :not(caption)>*>* {
            background-color: var(--color-table);
            color: var(--color-light);
            border-color: var(--color-dark);
        }

        .table thead {
            background-color: var(--color-table-header);
        }

        .table tbody tr:hover {
            background-color: var(--color-table-hover);
        }

        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-dark);
        }

        .btn-primary:hover {
            background-color: #1ed0b0;
            border-color: #1ed0b0;
        }

        .nav-link {
            color: var(--color-light);
        }

        .nav-link.active {
            color: var(--color-primary) !important;
            border-bottom: 2px solid var(--color-primary);
        }

        /* Utilidades espec√≠ficas */
        .user-status-badge {
            min-width: 60px;
        }

        .whatsapp-preview-box {
            background-color: #25d3661a;
            border: 1px solid #25d366;
            padding: 10px;
            border-radius: 8px;
            white-space: pre-wrap;
            color: var(--color-light);
        }
    </style>
</head>

<body>
    <div class="container-fluid py-3">
        <h1 class="text-center mb-4 text-white">Antolog√≠a Box23 <span style="color:var(--color-primary)">Manager</span>
        </h1>

        <ul class="nav nav-tabs justify-content-center mb-4" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button"
                    role="tab" aria-controls="home" aria-selected="true"><i class="fas fa-home me-2"></i>Inicio</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button"
                    role="tab" aria-controls="register" aria-selected="false"><i
                        class="fas fa-user-plus me-2"></i>Registro</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button"
                    role="tab" aria-controls="search" aria-selected="false"><i
                        class="fas fa-users me-2"></i>Usuarios</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance"
                    type="button" role="tab" aria-controls="attendance" aria-selected="false"><i
                        class="fas fa-clipboard-list me-2"></i>Asistencia</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="finance-tab" data-bs-toggle="tab" data-bs-target="#finance" type="button"
                    role="tab" aria-controls="finance" aria-selected="false"><i
                        class="fas fa-money-bill-wave me-2"></i>Finanzas</button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="card p-3 mb-4">
                    <h5 class="card-title text-center text-primary">Informaci√≥n R√°pida del Sistema</h5>
                    <div class="row text-center mt-3">
                        <div class="col-md-4 mb-3">
                            <div class="p-3 bg-dark rounded">
                                <i class="fas fa-users fa-2x text-primary"></i>
                                <p class="mb-0 mt-2">Usuarios Activos</p>
                                <h3 id="activeUsersCount">0</h3>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="p-3 bg-dark rounded">
                                <i class="fas fa-birthday-cake fa-2x text-secondary"></i>
                                <p class="mb-0 mt-2">Pr√≥ximos Cumplea√±os</p>
                                <h3 id="birthdayCount">0</h3>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="p-3 bg-dark rounded">
                                <i class="fas fa-clipboard-check fa-2x text-success"></i>
                                <p class="mb-0 mt-2">Asistencias Hoy</p>
                                <h3 id="todayAttendanceCount">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-3">
                    <h5 class="card-title text-primary">Cumplea√±os Pr√≥ximos</h5>
                    <div id="upcomingBirthdaysList" class="list-group">
                        <p class="text-center">No hay cumplea√±os pr√≥ximos.</p>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="register" role="tabpanel" aria-labelledby="register-tab">
                <div class="card p-4">
                    <h5 class="card-title text-primary">Formulario de Registro</h5>
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="accordion" id="accordionPersonal">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingPersonal">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                                data-bs-target="#collapsePersonal" aria-expanded="true"
                                                aria-controls="collapsePersonal">
                                                Datos Personales
                                            </button>
                                        </h2>
                                        <div id="collapsePersonal" class="accordion-collapse collapse show"
                                            aria-labelledby="headingPersonal" data-bs-parent="#accordionPersonal">
                                            <div class="accordion-body">
                                                <div class="mb-3">
                                                    <label for="name" class="form-label">Nombre Completo</label>
                                                    <input type="text" class="form-control" id="name" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="document" class="form-label">Documento</label>
                                                    <input type="text" class="form-control" id="document">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="birthdate" class="form-label">Fecha de
                                                        Nacimiento</label>
                                                    <input type="date" class="form-control" id="birthdate">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="phone" class="form-label">Tel√©fono</label>
                                                    <input type="tel" class="form-control" id="phone">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="accordion" id="accordionMedicalPlan">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingMedical">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                                data-bs-target="#collapseMedical" aria-expanded="true"
                                                aria-controls="collapseMedical">
                                                Datos M√©dicos y Emergencia
                                            </button>
                                        </h2>
                                        <div id="collapseMedical" class="accordion-collapse collapse show"
                                            aria-labelledby="headingMedical" data-bs-parent="#accordionMedicalPlan">
                                            <div class="accordion-body">
                                                <div class="mb-3">
                                                    <label for="eps" class="form-label">EPS</label>
                                                    <input type="text" class="form-control" id="eps">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="rh" class="form-label">RH</label>
                                                    <input type="text" class="form-control" id="rh">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="pathology" class="form-label">Patolog√≠a/Alergias</label>
                                                    <textarea class="form-control" id="pathology"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="emergencyContact" class="form-label">Contacto de
                                                        Emergencia</label>
                                                    <input type="text" class="form-control" id="emergencyContact">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="emergencyPhone" class="form-label">Tel√©fono de
                                                        Emergencia</label>
                                                    <input type="tel" class="form-control" id="emergencyPhone">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingPlan">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapsePlan"
                                                aria-expanded="false" aria-controls="collapsePlan">
                                                Datos del Plan
                                            </button>
                                        </h2>
                                        <div id="collapsePlan" class="accordion-collapse collapse"
                                            aria-labelledby="headingPlan" data-bs-parent="#accordionMedicalPlan">
                                            <div class="accordion-body">
                                                <div class="mb-3">
                                                    <label for="classTime" class="form-label">Horario de Clase</label>
                                                    <select class="form-select" id="classTime">
                                                        <option value="">Seleccione</option>
                                                        <option value="5:00 am">5:00 am</option>
                                                        <option value="6:00 am">6:00 am</option>
                                                        <option value="7:00 am">7:00 am</option>
                                                        <option value="5:00 pm">5:00 pm</option>
                                                        <option value="6:00 pm">6:00 pm</option>
                                                        <option value="7:00 pm">7:00 pm</option>
                                                        <option value="8:00 pm">8:00 pm</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="affiliationType" class="form-label">Tipo de
                                                        Afiliaci√≥n</label>
                                                    <select class="form-select" id="affiliationType" required>
                                                        <option value="">Seleccione</option>
                                                        <option value="mensualidad">Mensualidad</option>
                                                        <option value="trimestral">Trimestral</option>
                                                        <option value="semestral">Semestral</option>
                                                        <option value="diario">Diario</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary" id="userFormSubmit">Registrar Usuario</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="search" role="tabpanel" aria-labelledby="search-tab">
                <div class="card p-3">
                    <h5 class="card-title text-primary">Lista de Usuarios</h5>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="searchUser" placeholder="Buscar por nombre o ID...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Documento</th>
                                    <th>Tel√©fono</th>
                                    <th>Horario</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersList">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="attendance" role="tabpanel" aria-labelledby="attendance-tab">
                <div class="card p-4">
                    <h5 class="card-title text-primary">Registro de Asistencia</h5>
                    <form id="attendanceForm">
                        <div class="mb-3">
                            <label for="userSelectAttendance" class="form-label">Seleccionar Usuario</label>
                            <select class="form-select" id="userSelectAttendance" required>
                                </select>
                        </div>
                        <div class="mb-3">
                            <label for="dateAttendance" class="form-label">Fecha de Asistencia</label>
                            <input type="date" class="form-control" id="dateAttendance" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary"><i
                                    class="fas fa-check-circle me-2"></i>Registrar Asistencia</button>
                        </div>
                    </form>
                    <hr>
                    <h5 class="card-title text-primary mt-4">Asistencias del D√≠a</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Usuario</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="todayAttendanceList">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="finance" role="tabpanel" aria-labelledby="finance-tab">
                <div class="card p-4">
                    <h5 class="card-title text-primary">Registro de Pagos (Ingresos)</h5>
                    <form id="incomeForm">
                        <div class="mb-3">
                            <label for="userSelectIncome" class="form-label">Usuario que Paga</label>
                            <select class="form-select" id="userSelectIncome" required>
                                </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="paymentDate" class="form-label">Fecha de Pago</label>
                                <input type="date" class="form-control" id="paymentDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="amount" class="form-label">Monto ($)</label>
                                <input type="number" class="form-control" id="amount" required step="0.01">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="startDate" class="form-label">Inicio del Periodo</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="endDate" class="form-label">Fin del Periodo</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">M√©todo de Pago</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="Mensualidad">Mensualidad</option>
                                <option value="Clase suelta">Clase suelta</option>
                                <option value="Paquete 10 clases">Paquete 10 clases</option>
                                <option value="Personalizado Diana">Personalizado Diana</option>                                
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Descripci√≥n / Concepto</label>
                            <textarea class="form-control" id="description"></textarea>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary"><i
                                    class="fas fa-money-check-alt me-2"></i>Registrar Ingreso</button>
                        </div>
                    </form>
                    <hr>
                    <h5 class="card-title text-primary mt-4">Resumen Financiero (Pendiente)</h5>
                    <p>Esta secci√≥n se completar√° para leer los datos de la tabla `income`.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="emergencyModal" tabindex="-1" aria-labelledby="emergencyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emergencyModalLabel"><i class="fas fa-first-aid me-2"></i>Info. de
                        Emergencia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 class="text-primary" id="emergencyUserName"></h6>
                    <p><strong>Contacto:</strong> <span id="emergencyContactName"></span></p>
                    <p><strong>Tel√©fono:</strong> <span id="emergencyContactPhone"></span></p>
                    <p><strong>EPS:</strong> <span id="emergencyEps"></span></p>
                    <p><strong>RH:</strong> <span id="emergencyRh"></span></p>
                    <p><strong>Patolog√≠a/Alergias:</strong> <span id="emergencyPathology"></span></p>
                </div>
                <div class="modal-footer">
                    <a id="whatsappEmergency" href="#" target="_blank" class="btn btn-success"><i
                            class="fab fa-whatsapp me-2"></i>Enviar WhatsApp</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="whatsappModal" tabindex="-1" aria-labelledby="whatsappModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="whatsappModalLabel"><i class="fab fa-whatsapp me-2"></i>Enviar WhatsApp
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="whatsappPhone" class="form-label">Tel√©fono Destino (Formato 57XXXXXXXXXX)</label>
                        <input type="tel" class="form-control" id="whatsappPhone">
                    </div>
                    <div class="mb-3">
                        <label for="whatsappMessage" class="form-label">Mensaje</label>
                        <textarea class="form-control" id="whatsappMessage" rows="5"></textarea>
                        <small class="form-text text-muted">Previsualizaci√≥n del mensaje:</small>
                        <div class="whatsapp-preview-box mt-2" id="messagePreview"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <a id="sendWhatsappLink" href="#" target="_blank" class="btn btn-success"><i
                            class="fab fa-whatsapp me-2"></i>Abrir WhatsApp</a>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Variables Globales
        let users = [];
        const USERS_KEY = 'antologia_box23_users'; // Ya no se usa, pero se mantiene por si acaso
        const ATTENDANCE_KEY = 'antologia_box23_attendance'; // Ya no se usa

        // Referencias del DOM
        const usersList = document.getElementById('usersList');
        const userForm = document.getElementById('userForm');
        const userFormSubmit = document.getElementById('userFormSubmit');
        const searchUser = document.getElementById('searchUser');
        const attendanceForm = document.getElementById('attendanceForm');
        const incomeForm = document.getElementById('incomeForm');
        const userSelectAttendance = document.getElementById('userSelectAttendance');
        const userSelectIncome = document.getElementById('userSelectIncome');
        const todayAttendanceList = document.getElementById('todayAttendanceList');

        // Funci√≥n de utilidad para obtener ID de usuario
        function generateUserId() {
            const numUsers = users.length + 1;
            return `ATG${String(numUsers).padStart(4, '0')}`;
        }

        // --- FUNCIONES DE CONEXI√ìN A NEON (V√≠a Vercel Serverless) ---

        /**
         * Carga los usuarios de la base de datos Neon (GET /api/usuarios).
         */
        async function loadUsers() {
            try {
                const response = await fetch('/api/usuarios', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                users = await response.json();
                
                // Mantiene el resto de la l√≥gica de renderizado
                renderUsersList();
                loadUserSelects();
                updateSystemInfo();

            } catch (error) {
                console.error("Error cargando usuarios desde Neon:", error);
                alert("Error cr√≠tico al cargar usuarios. Intente recargar la p√°gina.");
            }
        }

        /**
         * Guarda o actualiza un usuario en la base de datos Neon (POST/PUT /api/usuarios).
         */
        async function saveUser(userData, isEdit) {
            try {
                const method = isEdit ? 'PUT' : 'POST';
                const response = await fetch('/api/usuarios', {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `Error al guardar usuario. C√≥digo: ${response.status}`);
                }

                alert(`Usuario ${isEdit ? 'actualizado' : 'registrado'} con √©xito.`);
                userForm.reset();
                document.getElementById('userId').value = '';
                userFormSubmit.textContent = 'Registrar Usuario';
                loadUsers(); // Recarga los datos

            } catch (error) {
                console.error("Error al guardar usuario en Neon:", error);
                alert("Error al guardar usuario: " + error.message);
            }
        }
        
        /**
         * Registra asistencia o pago en la base de datos Neon (POST /api/asistencia).
         */
        async function registerAction(data) {
            try {
                const response = await fetch('/api/asistencia', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `Error al registrar acci√≥n. C√≥digo: ${response.status}`);
                }

                alert(result.message);
                loadUsers(); // Podr√≠a ser necesario para actualizar contadores

            } catch (error) {
                console.error("Error al registrar acci√≥n en Neon:", error);
                alert("Error al registrar: " + error.message);
            }
        }


        // --- L√ìGICA DE MANEJO DE FORMULARIOS Y EVENTOS ---

        // Listener para el formulario de USUARIOS (Guardar/Actualizar)
        userForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const userId = document.getElementById('userId').value;
            const isEdit = !!userId;
            const userData = {
                id: isEdit ? userId : generateUserId(),
                name: document.getElementById('name').value,
                document: document.getElementById('document').value,
                birthdate: document.getElementById('birthdate').value || null, // Permite nulo
                phone: document.getElementById('phone').value,
                eps: document.getElementById('eps').value,
                rh: document.getElementById('rh').value,
                pathology: document.getElementById('pathology').value,
                emergencyContact: document.getElementById('emergencyContact').value,
                emergencyPhone: document.getElementById('emergencyPhone').value,
                classTime: document.getElementById('classTime').value,
                affiliationType: document.getElementById('affiliationType').value,
                // Si es edici√≥n, puedes agregar el status si lo modificaste
                status: isEdit ? (users.find(u => u.id === userId)?.status || 'active') : 'active' 
            };

            saveUser(userData, isEdit);
        });

        // Listener para el formulario de ASISTENCIA
        attendanceForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const userId = userSelectAttendance.value;
            const date = document.getElementById('dateAttendance').value;

            if (!userId || !date) {
                alert('Por favor, seleccione un usuario y una fecha.');
                return;
            }

            const data = {
                type: 'attendance',
                userId: userId,
                date: date
            };
            
            registerAction(data);
            attendanceForm.reset();
            document.getElementById('dateAttendance').valueAsDate = new Date(); // Resetear a hoy
        });
        
        // Listener para el formulario de PAGOS (INGRESOS)
        incomeForm.addEventListener('submit', function (e) {
            e.preventDefault();
            // Obtenemos el valor del monto como STRING (puede tener comas o estar vac√≠o)
            const amountValue = document.getElementById('amount').value;
            // Intentamos parsearlo a Float
            const parsedAmount = parseFloat(amountValue);
            
            const data = {
                type: 'income',
                userId: userSelectIncome.value,
                date: document.getElementById('paymentDate').value,
                startDate: document.getElementById('startDate').value || null,
                endDate: document.getElementById('endDate').value || null,
                paymentMethod: document.getElementById('paymentMethod').value,
                amount: parsedAmount,
                description: document.getElementById('description').value
            };
            
            if (!data.userId || !data.date || isNaN(data.amount) || data.amount <= 0) {
                alert('ERROR: Aseg√∫rese de que el Usuario, la Fecha y un Monto (mayor a 0) est√©n correctamente ingresados.');
                return;
            }
            
            registerAction(data);
            incomeForm.reset();
        });

        // Funci√≥n para renderizar la lista de usuarios en la pesta√±a "Usuarios"
        function renderUsersList(filteredUsers = users) {
            usersList.innerHTML = '';
            filteredUsers.forEach(user => {
                const statusBadge = user.status === 'active'
                    ? '<span class="badge bg-success user-status-badge">Activo</span>'
                    : '<span class="badge bg-danger user-status-badge">Inactivo</span>';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.document || '-'}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${user.classTime || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editUser('${user.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-warning me-1" onclick="showEmergencyInfo('${user.id}')"><i class="fas fa-first-aid"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                usersList.appendChild(row);
            });
        }


        // Funci√≥n para cargar los selectores de usuario
        function loadUserSelects() {
            userSelectAttendance.innerHTML = '<option value="">Seleccione Usuario</option>';
            userSelectIncome.innerHTML = '<option value="">Seleccione Usuario</option>';

            users.filter(u => u.status === 'active').forEach(user => {
                const option = `<option value="${user.id}">${user.name} (${user.id})</option>`;
                userSelectAttendance.innerHTML += option;
                userSelectIncome.innerHTML += option;
            });
        }

        // B√∫squeda de usuarios
        searchUser.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const filtered = users.filter(user =>
                user.name.toLowerCase().includes(searchTerm) ||
                user.id.toLowerCase().includes(searchTerm) ||
                user.document.toLowerCase().includes(searchTerm)
            );
            renderUsersList(filtered);
        });

        // --- FUNCIONES DE ACCI√ìN (Editar, Eliminar, Info) ---

        // Rellena el formulario para edici√≥n
        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            // Rellenar todos los campos del formulario
            document.getElementById('userId').value = user.id;
            document.getElementById('name').value = user.name;
            document.getElementById('document').value = user.document || '';
            document.getElementById('birthdate').value = user.birthdate || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('eps').value = user.eps || '';
            document.getElementById('rh').value = user.rh || '';
            document.getElementById('pathology').value = user.pathology || '';
            document.getElementById('emergencyContact').value = user.emergencyContact || '';
            document.getElementById('emergencyPhone').value = user.emergencyPhone || '';
            document.getElementById('classTime').value = user.classTime || '';
            document.getElementById('affiliationType').value = user.affiliationType || '';

            userFormSubmit.textContent = 'Actualizar Usuario';
            const registerTabBtn = document.getElementById('register-tab');
            const registerTab = bootstrap.Tab.getOrCreateInstance(registerTabBtn);
            registerTab.show();
        }

        // Elimina un usuario
        async function deleteUser(id) {
            if (!confirm('¬øEst√° seguro de que desea eliminar a este usuario? Esta acci√≥n es irreversible.')) {
                return;
            }

            try {
                const response = await fetch(`/api/usuarios?id=${id}`, {
                    method: 'DELETE',
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `Error al eliminar usuario. C√≥digo: ${response.status}`);
                }

                alert('Usuario eliminado con √©xito.');
                loadUsers(); // Recargar la lista
                
            } catch (error) {
                console.error("Error al eliminar usuario en Neon:", error);
                alert("Error al eliminar usuario: " + error.message);
            }
        }


        // Muestra la informaci√≥n de emergencia
        function showEmergencyInfo(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('emergencyUserName').textContent = user.name;
            document.getElementById('emergencyContactName').textContent = user.emergencyContact || 'N/A';
            document.getElementById('emergencyContactPhone').textContent = user.emergencyPhone || 'N/A';
            document.getElementById('emergencyEps').textContent = user.eps || 'N/A';
            document.getElementById('emergencyRh').textContent = user.rh || 'N/A';
            document.getElementById('emergencyPathology').textContent = user.pathology || 'Ninguna';

            // WhatsApp para emergencia
            const phone = user.emergencyPhone ? `57${user.emergencyPhone.replace(/\D/g, '')}` : '';
            const message = encodeURIComponent(`Hola, somos de Antolog√≠a Box23. Estamos llamando por una emergencia m√©dica con ${user.name}. Por favor, conteste la llamada.`);
            document.getElementById('whatsappEmergency').href = `https://wa.me/${phone}?text=${message}`;


            const emergencyModal = new bootstrap.Modal(document.getElementById('emergencyModal'));
            emergencyModal.show();
        }


        // --- FUNCIONES DE INFORMACI√ìN Y WIDGETS ---

        function updateSystemInfo() {
            const activeCount = users.filter(u => u.status === 'active').length;
            document.getElementById('activeUsersCount').textContent = activeCount;

            // TODO: Cargar el conteo de asistencia de la tabla `attendance`
            document.getElementById('todayAttendanceCount').textContent = '0 (Pr√≥ximamente)';
        }

        function checkUpcomingBirthdays() {
            const today = new Date();
            const next30Days = new Date();
            next30Days.setDate(today.getDate() + 30);
            
            const list = document.getElementById('upcomingBirthdaysList');
            list.innerHTML = '';
            let birthdayCount = 0;

            // Filtramos usuarios cuya fecha de nacimiento cae entre hoy y los pr√≥ximos 30 d√≠as
            const upcoming = users.filter(user => {
                if (!user.birthdate) return false;

                const userDate = new Date(user.birthdate);
                // Creamos una fecha para este a√±o
                const thisYearBirthday = new Date(today.getFullYear(), userDate.getMonth(), userDate.getDate());
                
                // Si la fecha ya pas√≥ este a√±o, verificamos el pr√≥ximo a√±o (para el margen de 30 d√≠as)
                if (thisYearBirthday < today) {
                    thisYearBirthday.setFullYear(today.getFullYear() + 1);
                }

                return thisYearBirthday >= today && thisYearBirthday <= next30Days;
            }).sort((a, b) => {
                // Ordenar por fecha m√°s cercana
                const dateA = new Date(a.birthdate);
                const dateB = new Date(b.birthdate);
                // Ajustar al a√±o actual/pr√≥ximo para la comparaci√≥n
                dateA.setFullYear(today.getFullYear() + (dateA < today ? 1 : 0));
                dateB.setFullYear(today.getFullYear() + (dateB < today ? 1 : 0));
                return dateA - dateB;
            });


            if (upcoming.length > 0) {
                upcoming.forEach(user => {
                    const userBirthDate = new Date(user.birthdate);
                    const formattedDate = new Date(today.getFullYear(), userBirthDate.getMonth(), userBirthDate.getDate()).toLocaleDateString('es-ES', { month: 'long', day: 'numeric' });
                    
                    const listItem = document.createElement('div');
                    listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center', 'bg-dark', 'text-white');
                    listItem.innerHTML = `
                        <span class="text-primary">${user.name}</span>
                        <span class="badge bg-secondary rounded-pill">${formattedDate}</span>
                        <button class="btn btn-sm btn-success" onclick="prepareBirthdayWishes('${user.phone || ''}', '${user.name}')"><i class="fab fa-whatsapp"></i> Felicitaci√≥n</button>
                    `;
                    list.appendChild(listItem);
                    birthdayCount++;
                });
            } else {
                list.innerHTML = '<p class="text-center p-3">No hay cumplea√±os en los pr√≥ximos 30 d√≠as.</p>';
            }
            document.getElementById('birthdayCount').textContent = birthdayCount;
        }
        
        // Preparar mensaje de WhatsApp para cumplea√±os
        function prepareBirthdayWishes(phone, name) {
            let message = `¬°Feliz cumplea√±os, ${name}! üéâüéÇ\n\nEn nombre de todo el equipo de Antolog√≠a Box23, queremos desearte un d√≠a maravilloso lleno de alegr√≠a, salud y muchas bendiciones. Que este nuevo a√±o de vida est√© cargado de √©xitos y momentos inolvidables.\n\n¬°Disfruta tu d√≠a especial! ü•≥`;

            // Rellenar el formulario de WhatsApp
            document.getElementById('whatsappPhone').value = phone ? `57${phone.replace(/\D/g, '')}` : '';
            document.getElementById('whatsappMessage').value = message;
            document.getElementById('messagePreview').textContent = message;

            // Actualizar link de env√≠o
            updateWhatsappLink();

            // Mostrar modal de WhatsApp
            const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
            whatsappModal.show();
        }

        // Funci√≥n para actualizar el enlace de WhatsApp
        function updateWhatsappLink() {
            const phone = document.getElementById('whatsappPhone').value.replace(/\D/g, '');
            const message = encodeURIComponent(document.getElementById('whatsappMessage').value);
            document.getElementById('sendWhatsappLink').href = `https://wa.me/${phone}?text=${message}`;
        }
        
        // Asegurar que el link de WhatsApp se actualice al cambiar tel√©fono o mensaje
        document.getElementById('whatsappPhone').addEventListener('input', updateWhatsappLink);
        document.getElementById('whatsappMessage').addEventListener('input', updateWhatsappLink);
        

        // No necesitas checkAutoBackup() ya que ahora usas una DB en la nube.
        // La informaci√≥n ya est√° segura en Neon.

        // Inicializar la aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar la fecha de asistencia a HOY por defecto
            document.getElementById('dateAttendance').valueAsDate = new Date();
            document.getElementById('paymentDate').valueAsDate = new Date();
            
            // 1. Carga inicial de datos desde Neon
            loadUsers(); 

            // 2. Verificar cumplea√±os pr√≥ximos despu√©s de cargar los usuarios
            setTimeout(() => {
                checkUpcomingBirthdays();
            }, 1500); // Peque√±o delay para asegurar que loadUsers termin√≥

        });
        
        // Manejo de rutas para SPA en GitHub Pages (Mantenido)
        (function () {
            var redirect = sessionStorage.redirect;
            delete sessionStorage.redirect;
            if (redirect && redirect != location.href) {
                history.replaceState(null, null, redirect);
            }
        })();
    </script>
</body>

</html>



